<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CTL48 Admin (Supabase Edition)</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary: #e91e63;
      --bg: #f4f6f8;
    }

    body {
      background: var(--bg);
      margin: 0;
      padding-bottom: 100px;
      font-family: 'Roboto', sans-serif;
      color: #333;
    }

    .header {
      background: linear-gradient(135deg, var(--primary), #ff5f9e);
      padding: 15px;
      text-align: center;
      color: #fff;
      font-weight: 900;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .1);
    }

    .section {
      display: none;
      padding: 15px;
      animation: fadeIn .25s;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .05);
    }

    label {
      display: block;
      font-size: .85rem;
      font-weight: 900;
      color: #444;
      margin-top: 12px;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .4px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      font-size: 1rem;
      transition: .2s;
      color: #333;
      appearance: none;
      -webkit-appearance: none;
    }

    textarea {
      resize: vertical;
    }

    .btn-main {
      width: 100%;
      padding: 15px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 50px;
      font-weight: 900;
      margin-top: 16px;
      font-size: 1rem;
      cursor: pointer;
    }

    .btn-main:active {
      transform: scale(.98);
    }

    .btn-ghost {
      width: 100%;
      padding: 15px;
      border-radius: 50px;
      font-weight: 900;
      border: 2px solid #333;
      background: #fff;
      color: #333;
      cursor: pointer;
    }

    .input-group {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 5px;
    }

    .btn-upload {
      background: #333;
      color: #fff;
      border: none;
      padding: 12px 15px;
      border-radius: 10px;
      cursor: pointer;
      white-space: nowrap;
    }

    .upload-status {
      font-size: .78rem;
      color: #e91e63;
      margin-top: 6px;
      font-weight: 900;
      min-height: 15px;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 70px;
      background: #fff;
      display: flex;
      border-top: 1px solid #eee;
      z-index: 1000;
    }

    .nav-item {
      flex: 1;
      border: none;
      background: none;
      color: #999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: .7rem;
      font-weight: 900;
      cursor: pointer;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item i {
      font-size: 1.4rem;
      margin-bottom: 4px;
    }

    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, .92);
      z-index: 5000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 16px;
      box-sizing: border-box;
    }

    #loading-log {
      margin-top: 10px;
      font-weight: 900;
      font-size: .85rem;
      color: #333;
      max-width: 560px;
      width: 100%;
      white-space: pre-line;
    }

    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0)
      }

      100% {
        transform: rotate(360deg)
      }
    }

    /* --- BUILDER STYLES --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      z-index: 2000;
      display: none;
      flex-direction: column;
      overflow-y: auto;
    }

    .modal-overlay.active {
      display: flex;
      animation: slideUp .25s;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%)
      }

      to {
        transform: translateY(0)
      }
    }

    .modal-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 10;
    }

    .modal-header button {
      border: none;
      background: none;
      font-size: 1.6rem;
      cursor: pointer;
    }

    .stage-area {
      padding: 20px;
    }

    .rows-panel {
      margin-top: 10px;
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 12px;
      background: #fafafa;
    }

    .rows-panel .rowline {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    .row-tag {
      min-width: 92px;
      font-size: .75rem;
      font-weight: 900;
      color: #444;
      text-transform: uppercase;
    }

    .slots-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      padding: 18px;
      border: 2px dashed #ddd;
      margin-top: 15px;
      border-radius: 12px;
      background: #fafafa;
    }

    .rows-wrap {
      display: flex;
      flex-direction: column;
      gap: 14px;
      width: 100%;
    }

    .slots-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .slot {
      width: 74px;
      text-align: center;
      position: relative;
      cursor: pointer;
      transition: transform .2s;
    }

    .slot:active {
      transform: scale(.92);
    }

    .slot-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto;
      overflow: hidden;
      position: relative;
    }

    .slot.is-center .slot-circle {
      border-color: #e91e63;
      z-index: 2;
      box-shadow: 0 0 0 4px rgba(233, 30, 99, .4);
      transform: scale(1.05);
    }

    .slot-badge {
      position: absolute;
      bottom: 18px;
      right: 2px;
      background: #333;
      color: #fff;
      width: 20px;
      height: 20px;
      font-size: .65rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      border: 2px solid #fff;
      font-weight: 900;
    }

    .slot.is-center .slot-badge {
      background: #e91e63;
    }

    .slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .slot-name {
      font-size: .68rem;
      margin-top: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 900;
    }

    /* SELECTION MODAL */
    .selection-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .8);
      z-index: 3000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .selection-box {
      background: #fff;
      width: 90%;
      max-height: 80vh;
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(78px, 1fr));
      gap: 10px;
      overflow-y: auto;
      padding: 10px;
    }

    .select-item {
      text-align: center;
      cursor: pointer;
      padding: 6px;
      border-radius: 10px;
      transition: .2s;
      position: relative;
      user-select: none;
    }

    .select-item:hover {
      background: #f5f5f5;
    }

    .select-item img {
      width: 66px;
      height: 66px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #eee;
    }

    .select-item div {
      font-size: .72rem;
      font-weight: 900;
      margin-top: 6px;
      line-height: 1.15;
    }

    .select-item.is-picked {
      background: #fff0f5;
      outline: 2px solid #e91e63;
    }

    /* TRACK ITEM */
    .track-item {
      background: #fff0f5;
      padding: 10px 12px;
      border-radius: 10px;
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #ffc1e3;
      gap: 10px;
    }

    .track-info {
      flex: 1;
    }

    .track-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .btn-icon {
      border: none;
      background: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #555;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .btn-icon.delete {
      color: #f44336;
      background: #ffebee;
    }

    .badge {
      font-size: .72rem;
      font-weight: 900;
      border-radius: 999px;
      padding: 4px 10px;
      background: #333;
      color: #fff;
      text-transform: uppercase;
      display: inline-block;
      margin-left: 6px;
    }

    .track-center-badge {
      font-size: .78rem;
      color: #e91e63;
      font-weight: 900;
      margin-top: 6px;
    }

    /* PARTS EDITOR */
    .part-card {
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 12px;
      background: #fafafa;
      margin-bottom: 10px;
    }

    .part-top {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
    }

    .part-track {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-top: 8px;
    }

    .part-btn {
      border: none;
      cursor: pointer;
      font-weight: 900;
      border-radius: 999px;
      padding: 8px 10px;
    }

    .part-btn-danger {
      background: #f44336;
      color: #fff;
    }

    .part-btn-soft {
      background: #333;
      color: #fff;
    }
  </style>
</head>

<body>

  <div class="header">CTL48 Admin (Supabase)</div>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">Processando...</div>
    <div id="loading-log"></div>
  </div>

  <div id="tab-news" class="section">
    <div class="card">
      <h2>üì¢ Nova Not√≠cia</h2>
      <form onsubmit="saveNews(event)">
        <label>T√≠tulo</label><input id="n-title" required />
        <label>Categoria</label>
        <select id="n-cat">
          <option>Release</option>
          <option>Event</option>
          <option>Notice</option>
          <option>Theater</option>
        </select>
        <label>Data</label><input type="date" id="n-date" required />
        <label>Conte√∫do</label><textarea id="n-text" rows="5"></textarea>
        <button class="btn-main">Publicar</button>
      </form>
    </div>
  </div>

  <div id="tab-disco" class="section active">
    <div class="card">
      <h2>üíø Discografia</h2>
      <form onsubmit="saveDisco(event)">
        <label>T√≠tulo</label><input id="d-title" required placeholder="Ex: 10th Single" />
        <div style="display:flex; gap:10px;">
          <div style="flex:1"><label>Tipo</label><select id="d-type">
              <option>Single</option>
              <option>Album</option>
              <option>Stage</option>
            </select></div>
          <div style="flex:1"><label>Data</label><input type="date" id="d-date" required /></div>
        </div>
        <label>Center (Auto)</label><input id="d-center" readonly style="background:#eee;" />

        <label>Capa (URL ou Upload)</label>
        <div class="input-group">
          <input id="d-cover" placeholder="https://..." required />
          <input type="file" id="d-cover-file" style="display:none" accept="image/*"
            onchange="uploadImage(this, 'd-cover', 'd-upload-status')" />
          <button type="button" class="btn-upload" onclick="document.getElementById('d-cover-file').click()"><i
              class="fas fa-upload"></i></button>
        </div>
        <div id="d-upload-status" class="upload-status"></div>

        <div style="margin-top:16px; border-top:1px solid #eee; padding-top:14px;">
          <label>M√∫sicas & Forma√ß√µes</label>
          <div id="tracks-list">
            <div style="text-align:center;color:#999;font-size:.85rem;">Vazio</div>
          </div>
          <button type="button" class="btn-main" style="background:#333; margin-top:10px;"
            onclick="openBuilder(false)">+ Adicionar M√∫sica</button>
        </div>
        <button class="btn-main">Salvar Tudo</button>
      </form>
    </div>
  </div>

  <div id="tab-members" class="section">
    <div class="card">
      <h2>üë§ Novo Membro</h2>
      <form onsubmit="saveMember(event)">
        <label>Nome</label><input id="m-name" required />
        <div style="display:flex; gap:10px;">
          <div style="flex:1"><label>Time</label><select id="m-team">
              <option>Team C</option>
              <option>Team T</option>
              <option>Team L</option>
              <option>Team Kenkyuusei</option>
            </select></div>
          <div style="flex:1"><label>Gera√ß√£o (N¬∫)</label><input type="number" id="m-gen" required placeholder="Ex: 1" />
          </div>
        </div>
        <label>Status</label>
        <select id="m-status-select">
          <option value="Ativa">Ativa</option>
          <option value="Graduada">Graduada</option>
          <option value="Demitida">Demitida</option>
          <option value="Expulsa">Expulsa</option>
        </select>

        <label>Foto</label>
        <div class="input-group">
          <input id="m-photo" placeholder="https://..." required />
          <input type="file" id="m-photo-file" style="display:none" accept="image/*"
            onchange="uploadImage(this, 'm-photo', 'm-upload-status')" />
          <button type="button" class="btn-upload" onclick="document.getElementById('m-photo-file').click()"><i
              class="fas fa-upload"></i></button>
        </div>
        <div id="m-upload-status" class="upload-status"></div>

        <label>Biografia</label><textarea id="m-bio" rows="4"></textarea>
        <button class="btn-main">Cadastrar</button>
      </form>
    </div>
  </div>

  <div id="tab-manage" class="section">
    <div class="card">
      <h2>‚úèÔ∏è Editar Membro</h2>
      <input type="text" id="manage-search" class="search-input" placeholder="üîç Buscar membro..."
        oninput="renderManageSelect(this.value)" style="width:100%; padding:10px; margin-bottom:10px;" />
      <select id="manage-selector" onchange="fillEditForm()">
        <option value="">Carregando...</option>
      </select>

      <div id="edit-form" style="display:none; margin-top:15px;">
        <img id="e-preview" src=""
          style="width:80px;height:80px;border-radius:50%; margin-bottom:10px; border:2px solid #eee;" />
        <form onsubmit="updateMember(event)">
          <label>Nome</label><input id="e-name" required />
          <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Time</label><select id="e-team">
                <option>Team C</option>
                <option>Team T</option>
                <option>Team L</option>
                <option>Team Kenkyuusei</option>
              </select></div>
            <div style="flex:1"><label>Gera√ß√£o (N¬∫)</label><input type="number" id="e-gen" required /></div>
          </div>
          <label>Status</label><select id="e-status-select">
            <option value="Ativa">Ativa</option>
            <option value="Graduada">Graduada</option>
            <option value="Demitida">Demitida</option>
            <option value="Expulsa">Expulsa</option>
          </select>

          <label>Foto</label>
          <div class="input-group">
            <input id="e-photo" required onchange="document.getElementById('e-preview').src=this.value" />
            <input type="file" id="e-photo-file" style="display:none" accept="image/*"
              onchange="uploadImage(this, 'e-photo', 'e-upload-status')" />
            <button type="button" class="btn-upload" onclick="document.getElementById('e-photo-file').click()"><i
                class="fas fa-upload"></i></button>
          </div>
          <div id="e-upload-status" class="upload-status"></div>

          <label>Biografia</label><textarea id="e-bio" rows="5"></textarea>

          <label>Galeria (URLs)</label><textarea id="e-gallery" rows="5" placeholder="https://..."></textarea>
          <div class="input-group">
            <input type="file" id="e-gallery-files" hidden accept="image/*" multiple onchange="uploadGalleryFiles(this)" />
            <button type="button" class="btn-upload" onclick="document.getElementById('e-gallery-files').click()"><i
                class="fas fa-images"></i> Galeria Upload</button>
          </div>
          <div id="e-gallery-status" class="upload-status"></div>

          <label>Participa√ß√µes (JSON)</label><textarea id="e-part" rows="3"></textarea>

          <!-- ‚úÖ ALTERA√á√ÉO: bot√µes + limpeza √≥rf√£os -->
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button type="button" class="btn-ghost" style="flex:1; font-size:.9rem;" onclick="openPartEditor()">Editar
              (Visual)</button>
            <button type="button" class="btn-main" style="flex:1; background:#f44336; margin-top:0;"
              onclick="purgeLegacyParticipations()">Limpar antigas</button>
          </div>

          <div style="display:flex; gap:10px; margin-top:10px;">
            <button type="button" class="btn-main" style="flex:1; background:#333; margin-top:0;"
              onclick="purgeOrphanParticipationsForSelectedMember()">
              Limpar √≥rf√£os (este membro)
            </button>
            <button type="button" class="btn-main" style="flex:1; background:#000; margin-top:0;"
              onclick="purgeOrphanParticipationsAllMembers()">
              Limpar √≥rf√£os (TODOS)
            </button>
          </div>

          <button class="btn-main" style="background:#2196f3;">Salvar Altera√ß√µes</button>
        </form>
      </div>
    </div>
  </div>

  <div id="tab-managedisco" class="section">
    <div class="card">
      <h2>üóÇÔ∏è Gerenciar Discografia</h2>
      <select id="disco-selector" onchange="fillDiscoEditForm()">
        <option value="">Carregando...</option>
      </select>
      <div id="disco-edit-form" style="display:none; margin-top:15px;">
        <form onsubmit="updateDisco(event)">
          <label>T√≠tulo</label><input id="ed-title" readonly style="background:#eee; color:#777;" />
          <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Tipo</label><select id="ed-type">
                <option>Single</option>
                <option>Album</option>
                <option>Stage</option>
              </select></div>
            <div style="flex:1"><label>Data</label><input type="date" id="ed-date" required /></div>
          </div>
          <label>Center (Auto)</label><input id="ed-center" />
          <label>Capa</label><input id="ed-cover" required />

          <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <label style="color:#2196f3;">Lista de M√∫sicas (Editar)</label>
            <div id="ed-tracks-list" style="margin-bottom:15px;"></div>
            <button type="button" class="btn-ghost" style="font-size:.9rem;" onclick="openBuilder(true)">+ Adicionar Nova
              M√∫sica</button>
          </div>
          <button class="btn-main" style="background:#2196f3;">Salvar Altera√ß√µes</button>
        </form>
        <button class="btn-main" style="background:#f44336; margin-top:25px;" onclick="deleteDisco()">Deletar Disco
          (Cascade)</button>
      </div>
    </div>
  </div>

  <div id="builder-modal" class="modal-overlay">
    <div class="modal-header"><span style="font-weight:900;">Forma√ß√£o</span><button onclick="closeBuilder(true)">‚úï</button></div>
    <div id="step-1" style="padding:20px; display:block;">
      <label>M√∫sica</label><input id="b-song" placeholder="Nome da faixa" />
      <label>Tipo</label>
      <select id="b-kind" onchange="toggleKindRules()">
        <option value="A-side">A-side</option>
        <option value="B-side">B-side</option>
        <option value="Undergirls">Undergirls</option>
        <option value="Unit">Unit</option>
        <option value="Solo">Solo</option>
      </select>
      <div id="unit-fields" style="display:none;"><label>Nome Unit</label><input id="b-unit-name" /></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
        <div><label>Total</label><input type="number" id="b-total" value="16" min="1" oninput="syncRowsUI()" /></div>
        <div><label>Centers</label><input type="number" id="b-centers" value="1" min="0" oninput="syncRowsUI()" /></div>
      </div>
      <div id="manual-rows" class="rows-panel">
        <label>Fileiras</label>
        <select id="b-rowcount" onchange="renderRowInputs()">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
        </select>
        <div id="row-inputs"></div>
        <div class="row-sum">Soma: <b id="rows-sum" style="color:#00b894;">16</b> / <b id="rows-total">16</b></div>
      </div>
      <button class="btn-main" onclick="startStage()">Montar</button>
    </div>
    <div id="step-2" class="stage-area" style="display:none;">
      <div class="builder-topnote">Toque na bolinha para escolher!</div>
      <div id="slots" class="slots-container"></div>
      <div style="display:flex; gap:10px; margin-top:16px;">
        <button type="button" class="btn-ghost" onclick="backToFormationMenu()">Voltar</button>
        <button type="button" class="btn-main" style="background:#6c5ce7; margin-top:0;" onclick="captureFormation()">Print</button>
        <button type="button" class="btn-main" style="background:#00b894; margin-top:0;" onclick="finishTrack()">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="member-select-modal" class="selection-modal">
    <div class="selection-box">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <h3>Escolha</h3><button onclick="closeMemberModal()" style="border:none;background:none;font-size:1.5rem;">‚úï</button>
      </div>
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <select id="member-filter-team" onchange="renderMemberSelectionList()" style="flex:1;">
          <option value="">Times</option>
          <option>Team C</option>
          <option>Team T</option>
          <option>Team L</option>
          <option>Team Kenkyuusei</option>
        </select>
        <select id="member-filter-gen" onchange="renderMemberSelectionList()" style="flex:1;">
          <option value="">Gens</option>
          <option>1</option>
          <option>2</option>
          <option>3</option>
          <option>4</option>
          <option>5</option>
        </select>
      </div>
      <input id="member-search" class="search-input" placeholder="Buscar..." oninput="renderMemberSelectionList(this.value)"
        style="width:100%; padding:8px; margin-bottom:10px;" />
      <div id="selection-list" class="selection-grid"></div>
      <button onclick="clearSlot()" class="btn-main" style="background:#f44336; margin-top:10px;">Remover (Vazio)</button>
    </div>
  </div>

  <div id="part-editor-modal" class="selection-modal" style="display:none;">
    <div class="selection-box" style="max-width:980px; width:95%;">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <h3>Editar Participa√ß√µes</h3><button onclick="closePartEditor()" style="border:none;background:none;font-size:1.5rem;">‚úï</button>
      </div>
      <input id="part-search" class="search-input" placeholder="Buscar..." oninput="renderPartEditor()"
        style="width:100%; padding:8px; margin-bottom:10px;" />
      <div id="part-editor-list" style="overflow:auto; max-height:55vh; padding-right:4px;"></div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button type="button" class="btn-ghost" style="flex:1;" onclick="copyPartsToTextarea()">Copiar JSON</button>
        <button type="button" class="btn-main" style="flex:1; background:#2196f3; margin-top:0;"
          onclick="copyPartsToTextarea(); closePartEditor();">Salvar e fechar</button>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <button class="nav-item" onclick="nav('news', this)"><i class="fas fa-newspaper"></i>News</button>
    <button class="nav-item active" onclick="nav('disco', this)"><i class="fas fa-compact-disc"></i>Disco</button>
    <button class="nav-item" onclick="nav('members', this)"><i class="fas fa-user-plus"></i>Add</button>
    <button class="nav-item" onclick="nav('manage', this)"><i class="fas fa-edit"></i>Edit</button>
    <button class="nav-item" onclick="nav('managedisco', this)"><i class="fas fa-folder-open"></i>Discos</button>
  </div>

  <script>
    // === CONFIG SUPABASE ===
    const SUPABASE_URL = 'https://iooyygtaosshxygnhlco.supabase.co';
    // ‚ö†Ô∏è Seguran√ßa: N√ÉO use service_role no front-end. Use anon key + RLS, ou um backend.
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlvb3l5Z3Rhb3NzaHh5Z25obGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDEyNTUsImV4cCI6MjA4NDU3NzI1NX0.gfcVtNgn3g1gnFVrtaIqzkWxajYiV_KbtycYsE9OZ0Y";
    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // Nomes das tabelas
    const T_NEWS = "Noticias";
    const T_DISCO = "Discografia";
    const T_MEMBERS = "Membros";

    // ImgBB Key (Mantida)
    const IMGBB_KEY = "81f7ca81cf22d739de576bd1dac7dcc2";

    // === STATE ===
    let allMembers = [];
    let allDiscos = [];
    let activeSlot = null;
    let tracksBuffer = [];
    let builderIsEditMode = false;
    let currentEditingDiscoId = null;
    let partEditorData = [];

    // === HELPERS ===
    function $(id) { return document.getElementById(id); }
    function val(id) { const el = $(id); return el ? el.value : ""; }
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function showLoading(show, txt) {
      const el = $('loading-overlay');
      el.style.display = show ? 'flex' : 'none';
      if (txt) $('loading-text').innerText = txt;
      if (!show) setLoadingLog("");
    }

    function setLoadingLog(msg) {
      const el = $('loading-log');
      if (!el) return;
      el.innerHTML = msg ? String(msg) : '';
    }

    function resolveImage(field) {
      if (!field) return "";
      if (Array.isArray(field) && field.length > 0) field = field[0];
      if (typeof field === "object") {
        if (field.url) return String(field.url).trim();
        if (field.publicUrl) return String(field.publicUrl).trim();
        field = field.path || "";
      }
      let s = String(field).trim();
      if (!s) return "";
      if (s.includes("(") && s.includes(")") && s.includes("http")) {
        const lastOpen = s.lastIndexOf("(");
        const lastClose = s.lastIndexOf(")");
        if (lastOpen !== -1 && lastClose !== -1 && lastClose > lastOpen) {
          const inside = s.slice(lastOpen + 1, lastClose).trim();
          if (inside.startsWith("http://") || inside.startsWith("https://")) s = inside;
        }
      }
      s = s.replace(/^"+|"+$/g, "").trim();
      s = s.replace(/%20+$/g, "").trim();
      const firstHttp = s.indexOf("http");
      if (firstHttp > 0) s = s.slice(firstHttp).trim();
      if (s.startsWith("http://") || s.startsWith("https://")) return s;
      return "";
    }

    function resolveGallery(field) {
      if (!field) return [];
      if (Array.isArray(field)) return field.map(resolveImage).filter(Boolean);

      if (typeof field === "string" && field.trim().startsWith("[")) {
        try {
          const arr = JSON.parse(field);
          if (Array.isArray(arr)) return arr.map(resolveImage).filter(Boolean);
        } catch (e) { }
      }
      const one = resolveImage(field);
      return one ? [one] : [];
    }

    function nav(id, el) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      $('tab-' + id).classList.add('active');
      el.classList.add('active');
    }

    // --- IMG UPLOAD (ImgBB) ---
    async function uploadImage(input, targetId, statusId) {
      const file = input.files[0];
      if (!file) return;
      const statusEl = $(statusId);
      const targetEl = $(targetId);
      statusEl.innerText = "‚è≥ Enviando...";
      try {
        const base64 = await new Promise((r, j) => {
          const fr = new FileReader();
          fr.onload = () => r(fr.result);
          fr.onerror = j;
          fr.readAsDataURL(file);
        });
        const form = new URLSearchParams();
        form.append("key", IMGBB_KEY);
        form.append("image", String(base64).split(",")[1]);
        const res = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: form });
        const data = await res.json();
        if (!data?.success) throw new Error("Erro upload");
        targetEl.value = data.data.url;
        statusEl.innerText = "‚úÖ Ok!";
        if (targetId === 'e-photo') $('e-preview').src = data.data.url;
      } catch (e) {
        console.error(e);
        statusEl.innerText = "‚ùå Erro";
      }
    }

    // (Se voc√™ j√° tem essa fun√ß√£o em outro lugar, pode remover esta)
    async function uploadGalleryFiles(input) {
      const files = [...(input.files || [])];
      if (!files.length) return;
      const statusEl = $('e-gallery-status');
      statusEl.innerText = "‚è≥ Enviando galeria...";
      const urls = [];
      try {
        for (const f of files) {
          const base64 = await new Promise((r, j) => {
            const fr = new FileReader();
            fr.onload = () => r(fr.result);
            fr.onerror = j;
            fr.readAsDataURL(f);
          });
          const form = new URLSearchParams();
          form.append("key", IMGBB_KEY);
          form.append("image", String(base64).split(",")[1]);
          const res = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: form });
          const data = await res.json();
          if (!data?.success) throw new Error("Erro upload galeria");
          urls.push(data.data.url);
          await sleep(150);
        }
        const current = (val('e-gallery') || '').split("\n").map(s => s.trim()).filter(Boolean);
        $('e-gallery').value = [...current, ...urls].join("\n");
        statusEl.innerText = "‚úÖ Galeria ok!";
      } catch (e) {
        console.error(e);
        statusEl.innerText = "‚ùå Erro galeria";
      }
    }

    // --- DATA LOGIC (SUPABASE) ---
    async function loadMembers() {
      try {
        const { data, error } = await _supabase.from(T_MEMBERS).select('*').order('Time').order('Nome');
        if (error) throw error;

        allMembers = (data || []).map(x => ({
          id: x.id,
          name: x.Nome || '',
          photo: resolveImage(x.Foto),
          gallery: Array.isArray(x.Galeria) ? x.Galeria : (typeof x.Galeria === "string" ? x.Galeria : []),
          team: x.Time || '',
          gen: x.Geracao,
          status: x.Status || 'Ativa',
          bio: x.Perfil || '',
          part: x.Participacoes || '' // string JSON
        }));
        renderMemberSelectionList("");
        renderManageSelect("");
      } catch (e) {
        console.error(e);
        alert("Erro ao carregar membros: " + e.message);
      }
    }

    async function loadDiscos() {
      try {
        const { data, error } = await _supabase.from(T_DISCO).select('*').order('Data', { ascending: false });
        if (error) throw error;

        allDiscos = (data || []).map(rec => ({ id: rec.id, fields: rec }));

        const sel = $('disco-selector');
        sel.innerHTML = '<option value="">Selecione...</option>';
        allDiscos.forEach(rec => {
          const o = document.createElement('option');
          o.value = rec.id;
          o.text = rec.fields.Titulo || '(Sem t√≠tulo)';
          sel.appendChild(o);
        });
      } catch (e) {
        console.error(e);
      }
    }

    async function saveNews(e) {
      e.preventDefault();
      showLoading(true, "Publicando...");
      try {
        const { error } = await _supabase.from(T_NEWS).insert({
          Titulo: val('n-title'),
          Categoria: val('n-cat'),
          Data: val('n-date'),
          Texto: val('n-text')
        });
        if (error) throw error;
        alert("Not√≠cia publicada!");
        location.reload();
      } catch (err) {
        console.error(err);
        showLoading(false);
        alert("Erro: " + err.message);
      }
    }

    async function saveMember(e) {
      e.preventDefault();
      showLoading(true, "Cadastrando...");
      try {
        const { error } = await _supabase.from(T_MEMBERS).insert({
          Nome: val('m-name'),
          Time: val('m-team'),
          Geracao: val('m-gen') ? `${val('m-gen')}¬™ Gera√ß√£o` : '',
          Status: val('m-status-select'),
          Perfil: val('m-bio'),
          Foto: val('m-photo')
        });
        if (error) throw error;
        alert("Membro cadastrado!");
        location.reload();
      } catch (err) {
        console.error(err);
        showLoading(false);
        alert("Erro: " + err.message);
      }
    }

    /* =========================
       ‚úÖ SEGURAN√áA: Disco Index + discoId sempre + limpeza √≥rf√£os
       ========================= */
    async function getDiscoIndex() {
      const { data, error } = await _supabase.from(T_DISCO).select('id, Titulo');
      if (error) throw error;

      const idSet = new Set();
      const titleSet = new Set();
      const titleToId = new Map();

      (data || []).forEach(d => {
        const id = d?.id ? String(d.id) : '';
        const t = String(d?.Titulo || '').trim();
        const tl = t.toLowerCase();
        if (id) idSet.add(id);
        if (tl) {
          titleSet.add(tl);
          if (id) titleToId.set(tl, id);
        }
      });

      return { idSet, titleSet, titleToId };
    }

    function cleanupPartsAgainstIndex(parts, index) {
      const { idSet, titleSet } = index;
      const norm = normalizeParts(Array.isArray(parts) ? parts : []);

      return norm.filter(p => {
        const discoId = p.discoId ? String(p.discoId) : '';
        const title = String(p.single || '').trim().toLowerCase();

        if (discoId) return idSet.has(discoId);
        if (title) return titleSet.has(title);
        return false;
      });
    }

    function ensureDiscoIdSafety(parts, index) {
      const { titleToId, idSet } = index;
      const norm = normalizeParts(Array.isArray(parts) ? parts : []);

      return norm.map(p => {
        let discoId = p.discoId ? String(p.discoId) : '';
        const title = String(p.single || '').trim().toLowerCase();

        if (discoId && !idSet.has(discoId)) discoId = '';
        if (!discoId && title && titleToId.has(title)) discoId = titleToId.get(title);

        return { ...p, discoId: discoId || null };
      });
    }

  async function purgeOrphanParticipationsForSelectedMember() {
    const memId = val('manage-selector');
    if (!memId) return alert("Selecione um membro.");
    if (!confirm("Limpar participa√ß√µes √≥rf√£s deste membro?")) return;

    showLoading(true, "Limpando √≥rf√£os (membro)...");
    setLoadingLog("");

    try {
      const index = await getDiscoIndex();

      const { data, error } = await _supabase
        .from(T_MEMBERS)
        .select('Participacoes')
        .eq('id', memId)
        .single();
      if (error) throw error;

      let cur = [];
      try { cur = JSON.parse(data?.Participacoes || '[]'); } catch (e) { cur = []; }

      const withId = ensureDiscoIdSafety(cur, index);
      const cleaned = cleanupPartsAgainstIndex(withId, index);

      if (JSON.stringify(normalizeParts(cur)) === JSON.stringify(cleaned)) {
        showLoading(false);
        return alert("Nada para limpar (j√° est√° ok).");
      }

      const { error: upErr } = await _supabase
        .from(T_MEMBERS)
        .update({ Participacoes: JSON.stringify(cleaned) })
        .eq('id', memId);
      if (upErr) throw upErr;

      $('e-part').value = JSON.stringify(cleaned, null, 0);
      showLoading(false);
      alert("Limpeza conclu√≠da para este membro!");
    } catch (err) {
      console.error(err);
      showLoading(false);
      alert("Erro: " + err.message);
    }
  }

  async function purgeOrphanParticipationsAllMembers() {
    if (!confirm("Isso vai limpar participa√ß√µes √≥rf√£s de TODOS os membros. Continuar?")) return;

    showLoading(true, "Limpando √≥rf√£os (todos)...");
    setLoadingLog("Montando √≠ndice...");

    try {
      const index = await getDiscoIndex();

      const { data, error } = await _supabase
        .from(T_MEMBERS)
        .select('id, Nome, Participacoes');
      if (error) throw error;

      let changed = 0;
      let scanned = 0;

      for (const m of (data || [])) {
        scanned++;

        let cur = [];
        try { cur = JSON.parse(m?.Participacoes || '[]'); } catch (e) { cur = []; }

        const withId = ensureDiscoIdSafety(cur, index);
        const cleaned = cleanupPartsAgainstIndex(withId, index);

        if (JSON.stringify(normalizeParts(cur)) !== JSON.stringify(cleaned)) {
          const { error: upErr } = await _supabase
            .from(T_MEMBERS)
            .update({ Participacoes: JSON.stringify(cleaned) })
            .eq('id', m.id);
          if (upErr) throw upErr;

          changed++;
          await sleep(50);
        }

        if (scanned % 10 === 0) {
          setLoadingLog(`Verificados: ${scanned} | Alterados: ${changed}`);
        }
      }

      showLoading(false);
      alert(`Conclu√≠do! Verificados: ${scanned} | Alterados: ${changed}`);
    } catch (err) {
      console.error(err);
      showLoading(false);
      alert("Erro: " + err.message);
    }
  }

  /* =========================
     ‚úÖ PATCH: updateMember com seguran√ßa discoId + limpeza √≥rf√£os
     (substitua sua fun√ß√£o updateMember inteira por esta)
     ========================= */
  async function updateMember(e) {
    e.preventDefault();
    const id = val('manage-selector');
    if (!id) return;
    showLoading(true, "Salvando...");
    try {
      const galleryLines = (val('e-gallery') || '').split("\n").map(s => s.trim()).filter(Boolean);
      const galeriaJson = galleryLines.map(url => ({ url }));

      // ‚úÖ Seguran√ßa + limpeza antes de gravar
      const idx = await getDiscoIndex();
      let partNorm = normalizeParts(parsePartsSafe(val('e-part')));
      partNorm = ensureDiscoIdSafety(partNorm, idx);
      partNorm = cleanupPartsAgainstIndex(partNorm, idx);

      const { error } = await _supabase.from(T_MEMBERS).update({
        Nome: val('e-name'),
        Time: val('e-team'),
        Geracao: val('e-gen') ? `${val('e-gen')}¬™ Gera√ß√£o` : '',
        Status: val('e-status-select'),
        Perfil: val('e-bio'),
        Participacoes: JSON.stringify(partNorm),
        Foto: val('e-photo'),
        Galeria: galeriaJson
      }).eq('id', id);

      if (error) throw error;
      alert("Salvo!");
      location.reload();
    } catch (err) {
      console.error(err);
      showLoading(false);
      alert("Erro: " + err.message);
    }
  }

  /* =========================
     ‚úÖ PATCH: garantir discoId SEMPRE no hist√≥rico
     (substitua APENAS o push dentro de updateMembersHistoryByDiscoId)
     ========================= */
  // dentro de updateMembersHistoryByDiscoId, troque:
  // cleanHist.push({ discoId, single: singleTitle, tracks: newTracks });
  // por:
  //
  // cleanHist.push({
  //   discoId: String(discoId),
  //   single: String(singleTitle || '').trim(),
  //   tracks: newTracks
  // });

  /* =========================
     A PARTIR DAQUI: continua seu c√≥digo normal (o seu original)
     ========================= */

  async function saveDisco(e) {
    e.preventDefault();
    if (!tracksBuffer.length) return alert("Adicione m√∫sicas!");
    showLoading(true, "Salvando...");
    try {
      const html = buildHTML();
      const tipos = [...new Set(tracksBuffer.map(t => normalizeKind(t.kind)))].join(', ');
      const firstTrack = tracksBuffer[0];
      const centerStr = firstTrack ? (firstTrack.members || []).filter(m => m.isCenter).map(m => m.name).join(' & ') : '';

      const { data, error } = await _supabase.from(T_DISCO).insert({
        Titulo: val('d-title'),
        Tipo: val('d-type'),
        Center: centerStr || val('d-center'),
        Data: val('d-date'),
        Capa: val('d-cover'),
        Tracklist: html
      }).select();

      if (error) throw error;

      const discoId = data[0].id;
      await updateMembersHistoryByDiscoId(discoId, val('d-title'), tracksBuffer);
      alert("Sucesso!");
      location.reload();
    } catch (err) {
      console.error(err);
      showLoading(false);
      alert("Erro: " + err.message);
    }
  }

  async function updateDisco(e) {
    e.preventDefault();
    const id = currentEditingDiscoId;
    if (!id) return;
    showLoading(true, "Atualizando...");
    try {
      const html = buildHTML();
      const firstTrack = tracksBuffer[0];
      const centerStr = firstTrack ? (firstTrack.members || []).filter(m => m.isCenter).map(m => m.name).join(' & ') : '';

      const { error } = await _supabase.from(T_DISCO).update({
        Tipo: val('ed-type'),
        Data: val('ed-date'),
        Center: centerStr,
        Capa: val('ed-cover'),
        Tracklist: html
      }).eq('id', id);

      if (error) throw error;
      await updateMembersHistoryByDiscoId(id, val('ed-title'), tracksBuffer);
      alert("Atualizado!");
      location.reload();
    } catch (err) {
      console.error(err);
      showLoading(false);
      alert("Erro: " + err.message);
    }
  }

  async function deleteDisco() {
    const id = currentEditingDiscoId || $('disco-selector')?.value;
    if (!id) return;
    if (!confirm("Apagar disco e limpar hist√≥rico dos membros?")) return;
    showLoading(true, "Deletando...");
    try {
      const { error } = await _supabase.from(T_DISCO).delete().eq('id', id);
      if (error) throw error;
      await removeDiscoFromAllMembers(id);
      alert("Deletado!");
      location.reload();
    } catch (err) {
      console.error(err);
      showLoading(false);
      alert("Erro: " + err.message);
    }
  }

  async function updateMembersHistoryByDiscoId(discoId, singleTitle, tracks) {
    const memberUpdates = {};
    tracks.forEach(track => {
      const baseLabel = normalizeKind(track.kind);
      (track.members || []).forEach(mem => {
        if (!mem?.id) return;
        if (!memberUpdates[mem.id]) memberUpdates[mem.id] = [];
        const labels = [baseLabel];
        if (baseLabel === 'unit') labels.push('unit');
        if (mem.isCenter) labels.push('center');
        memberUpdates[mem.id].push({
          title: track.name,
          labels,
          unitName: track.unitName || ''
        });
      });
    });

    for (const [memId, newTracks] of Object.entries(memberUpdates)) {
      const { data } = await _supabase
        .from(T_MEMBERS)
        .select('Participacoes')
        .eq('id', memId)
        .single();

      let currentHist = [];
      try { currentHist = JSON.parse(data.Participacoes || '[]'); } catch (e) {}

      const cleanHist = currentHist.filter(h => String(h.discoId || '') !== String(discoId));

      // ‚úÖ AQUI √© o patch do discoId
      cleanHist.push({
        discoId: String(discoId),
        single: String(singleTitle || '').trim(),
        tracks: newTracks
      });

      await _supabase
        .from(T_MEMBERS)
        .update({ Participacoes: JSON.stringify(cleanHist) })
        .eq('id', memId);

      await sleep(50);
    }
  }

  async function removeDiscoFromAllMembers(discoId) {
    const { data } = await _supabase.from(T_MEMBERS).select('id, Participacoes');
    for (const m of (data || [])) {
      let h = [];
      try { h = JSON.parse(m.Participacoes || '[]'); } catch (e) { continue; }

      const newH = h.filter(x => String(x.discoId || '') !== String(discoId));
      if (newH.length !== h.length) {
        await _supabase.from(T_MEMBERS).update({
          Participacoes: JSON.stringify(newH)
        }).eq('id', m.id);
        await sleep(50);
      }
    }
  }

  function renderManageSelect(filter = "") {
    const sl = $('manage-selector');
    if (!sl) return;
    const q = (filter || "").toLowerCase();
    sl.innerHTML = '<option value="">Selecione...</option>';
    allMembers
      .filter(m => !q || m.name.toLowerCase().includes(q))
      .forEach(m => {
        const o = document.createElement('option');
        o.value = m.id;
        o.textContent = m.name;
        sl.appendChild(o);
      });
  }

  function fillEditForm() {
    const id = val('manage-selector');
    const box = $('edit-form');
    if (!id) {
      box.style.display = 'none';
      return;
    }

    const mem = allMembers.find(m => m.id == id);
    if (!mem) return;

    $('e-name').value = mem.name;
    $('e-team').value = mem.team;
    $('e-gen').value = mem.gen ? String(mem.gen).replace(/\D/g, '') : '';
    $('e-status-select').value = mem.status;

    $('e-bio').value = mem.bio;

    $('e-photo').value = resolveImage(mem.photo) || '';
    $('e-preview').src = resolveImage(mem.photo) || 'https://placehold.co/100?text=?';

    let urls = [];
    if (Array.isArray(mem.gallery)) {
      urls = mem.gallery.map(g => resolveImage(g.url ?? g)).filter(Boolean);
    } else {
      urls = resolveGallery(mem.gallery);
    }
    $('e-gallery').value = urls.join("\n");

    const normalized = normalizeParts(parsePartsSafe(mem.part));
    $('e-part').value = JSON.stringify(normalized, null, 0);

    box.style.display = 'block';
  }

  function fillDiscoEditForm() {
    const id = $('disco-selector')?.value;
    const box = $('disco-edit-form');
    if (!id) {
      box.style.display = 'none';
      currentEditingDiscoId = null;
      return;
    }
    currentEditingDiscoId = id;

    const rec = allDiscos.find(r => r.id == id);
    if (!rec) return;
    const f = rec.fields;

    $('ed-title').value = f.Titulo || '';
    $('ed-type').value = f.Tipo || 'Single';
    $('ed-date').value = (f.Data || '').slice(0, 10);
    $('ed-center').value = f.Center || '';
    $('ed-cover').value = f.Capa || '';

    const oldHTML = f.Tracklist || '';
    tracksBuffer = parseHTMLToTracks(oldHTML);
    updateTracks(true);
    box.style.display = 'block';
  }

  function normalizeKind(k) {
    const s = String(k || '').trim().toLowerCase();
    if (s.includes('a-side')) return 'a-side';
    if (s.includes('under')) return 'undergirls';
    if (s.includes('unit')) return 'unit';
    if (s.includes('solo')) return 'solo';
    return 'b-side';
  }

  function formatGen(g) {
    const n = g ? String(g).replace(/\D/g, '') : '';
    return n ? `${n}¬™ Gen` : '';
  }

  function parseHTMLToTracks(htmlString) {
    if (!htmlString) return [];
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlString;
    const hiddenDataEl = tempDiv.querySelector('#ctl48-formation-data');
    if (hiddenDataEl) {
      try {
        const data = JSON.parse(hiddenDataEl.innerText);
        return data.map(t => ({ ...t, html: null }));
      } catch (e) { }
    }
    return [];
  }

  function buildHTML() {
    let html = `<div class="modal-nav"><button class="modal-nav-btn active" data-section="tracklist">Tracklist</button><button class="modal-nav-btn" data-section="formacao">Forma√ß√£o</button></div><div class="details-content"><div class="modal-section active" data-section="tracklist"><ol class="tracklist">`;
    let forms = `<div class="modal-section" data-section="formacao">`;
    tracksBuffer.forEach((t, index) => {
      const kindClass = normalizeKind(t.kind);
      const unitTxt = (String(t.unitName || '').trim()) ? ` ‚Ä¢ ${t.unitName}` : '';
      html += `<li><a>${t.name}</a> <span class="label ${kindClass}">${t.kind}${unitTxt}</span></li>`;
      forms += `<div class="formation-group"><div class="formation-title">${(String(t.kind) === 'Unit') ? '<i class="fas fa-users"></i>' : ''} ${t.name}</div><div class="member-grid">`;
      (t.members || []).forEach(mem => {
        let full = allMembers.find(am => am.id == mem.id);
        if (!full && mem.name) full = allMembers.find(am => am.name === mem.name);
        const centerClass = mem.isCenter ? 'is-center' : '';
        const photo = full?.photo || 'https://placehold.co/300?text=?';
        const name = full?.name || mem.name || '???';
        const genTxt = formatGen(full?.gen || mem.gen || '');
        if (full) mem.id = full.id;
        forms += `<a class="member-card-static ${centerClass}" data-id="${mem.id || ''}"><div class="member-photo"><img src="${photo}" loading="lazy"></div><div class="member-info"><h3>${name}</h3><p>${genTxt || ''}</p></div></a>`;
      });
      forms += `</div></div>`;
      if (index < tracksBuffer.length - 1) forms += `<hr class="formation-separator"/>`;
    });
    forms += `</div></div>`;
    const hiddenData = `<div id="ctl48-formation-data" style="display:none;">${JSON.stringify(tracksBuffer)}</div>`;
    return html + `</ol></div>` + forms + hiddenData + `</div>`;
  }

  function moveTrack(index, direction, isEdit) {
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= tracksBuffer.length) return;
    const temp = tracksBuffer[index];
    tracksBuffer[index] = tracksBuffer[newIndex];
    tracksBuffer[newIndex] = temp;
    updateTracks(isEdit);
  }

  function openBuilder(isEdit) {
    builderIsEditMode = !!isEdit;
    $('builder-modal').style.display = 'flex';
    $('builder-modal').classList.add('active');
    $('step-1').style.display = 'block';
    $('step-2').style.display = 'none';
    if (!$('row-inputs').children.length) renderRowInputs();
    $('b-song').value = '';
    $('b-unit-name').value = '';
    toggleKindRules();
    syncRowsUI();
  }

  function closeBuilder(reset = true) {
    $('builder-modal').classList.remove('active');
    $('builder-modal').style.display = 'none';
  }

  function backToFormationMenu() {
    $('step-2').style.display = 'none';
    $('step-1').style.display = 'block';
  }

  function syncRowsUI() {
    const total = parseInt(val('b-total')) || 0;
    $('rows-total').innerText = total;
    updateRowsSum();
  }

  function renderRowInputs() {
    const wrap = $('row-inputs');
    const count = parseInt(val('b-rowcount')) || 3;
    const old = [...wrap.querySelectorAll('.row-count-input')].map(i => parseInt(i.value) || 0);
    wrap.innerHTML = '';
    for (let i = 0; i < count; i++) {
      wrap.innerHTML += `<div class="rowline"><div class="row-tag">${i === 0 ? 'Frente' : (i === count - 1 ? 'Fundo' : `Meio ${i}`)}</div><input type="number" min="0" class="row-count-input" value="${old[i] || 0}" oninput="updateRowsSum()"></div>`;
    }
    updateRowsSum();
  }

  function updateRowsSum() {
    const total = parseInt(val('b-total')) || 0;
    const sum = [...document.querySelectorAll('.row-count-input')]
      .reduce((a, b) => a + (parseInt(b.value) || 0), 0);
    $('rows-sum').innerText = sum;
    $('rows-sum').style.color = (sum === total) ? '#00b894' : '#e91e63';
  }

  function toggleKindRules() {
    const k = val('b-kind');
    $('unit-fields').style.display = (k === 'Unit') ? 'block' : 'none';
    if (k === 'Solo') {
      $('b-total').value = 1;
      $('b-centers').value = 1;
      $('b-rowcount').value = 1;
      renderRowInputs();
      document.querySelector('.row-count-input').value = 1;
      syncRowsUI();
    }
  }

  function startStage() {
    const total = parseInt(val('b-total')) || 0;
    const inputs = [...document.querySelectorAll('.row-count-input')].map(i => parseInt(i.value) || 0);
    if (inputs.reduce((a, b) => a + b, 0) !== total) return alert("Soma incorreta.");

    const centerCount = parseInt(val('b-centers')) || 0;
    const frontRowCount = inputs[0] || 0;
    let cIdx = [];
    if (centerCount > 0 && frontRowCount > 0) {
      const start = Math.floor((frontRowCount - centerCount) / 2);
      for (let k = 0; k < centerCount; k++) cIdx.push(start + k);
    }

    const slotsWrap = $('slots');
    slotsWrap.innerHTML = '';
    const rowsWrap = document.createElement('div');
    rowsWrap.className = 'rows-wrap';

    function badgeFor(r, j) {
      const rowCount = inputs[r] || 0;
      const cumulative = inputs.slice(0, r + 1).reduce((a, b) => a + b, 0);
      if (r === 0) return (cumulative - rowCount + 1) + j;
      return cumulative - j;
    }

    for (let r = inputs.length - 1; r >= 0; r--) {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'slots-row';
      const isFront = (r === 0);
      for (let j = 0; j < inputs[r]; j++) {
        const d = document.createElement('div');
        d.className = 'slot';
        if (isFront && cIdx.includes(j)) d.classList.add('is-center');
        const badge = badgeFor(r, j);
        d.innerHTML = `<div class="slot-badge">${badge}</div><div class="slot-circle"><i class="fas fa-plus" style="color:#ddd"></i></div><div class="slot-name">-</div>`;
        d.onclick = () => openMemberModal(d);
        rowDiv.appendChild(d);
      }
      rowsWrap.appendChild(rowDiv);
    }

    slotsWrap.appendChild(rowsWrap);
    $('step-1').style.display = 'none';
    $('step-2').style.display = 'block';
  }

  function openMemberModal(el) {
    activeSlot = el;
    $('member-select-modal').style.display = 'flex';
    $('member-search').value = '';
    renderMemberSelectionList('');
  }

  function closeMemberModal() {
    $('member-select-modal').style.display = 'none';
    activeSlot = null;
  }

  function selectMember(m) {
    if (!activeSlot) return;
    const p = resolveImage(m.photo) || 'https://placehold.co/100?text=?';
    activeSlot.querySelector('.slot-circle').innerHTML = `<img src="${p}" onerror="this.src='https://placehold.co/100?text=?'">`;
    activeSlot.querySelector('.slot-name').innerText = m.name;
    activeSlot.dataset.id = m.id;
    activeSlot.dataset.name = m.name;
    activeSlot.dataset.gen = String(m.gen ?? '');
    closeMemberModal();
  }

  function clearSlot() {
    if (activeSlot) {
      activeSlot.querySelector('.slot-circle').innerHTML = '<i class="fas fa-plus" style="color:#ddd"></i>';
      activeSlot.querySelector('.slot-name').innerText = '-';
      delete activeSlot.dataset.id;
      delete activeSlot.dataset.name;
      delete activeSlot.dataset.gen;
    }
    closeMemberModal();
  }

  async function captureFormation() {
    const target = $('slots');
    try {
      const canvas = await html2canvas(target, { backgroundColor: "#fafafa", scale: 2, useCORS: true });
      const img = canvas.toDataURL("image/png");
      const a = document.createElement('a');
      a.href = img;
      a.download = 'formacao.png';
      a.click();
    } catch (e) {
      alert("Erro ao printar. Tente manual.");
    }
  }

  function finishTrack() {
    const name = val('b-song').trim();
    if (!name) return alert("Nome?");
    const slots = [...document.querySelectorAll('.slot')].filter(s => s.dataset.id);
    if (!slots.length) return alert("Selecione membros.");
    const members = slots.map(s => ({
      id: s.dataset.id,
      name: s.dataset.name,
      gen: s.dataset.gen || '',
      isCenter: s.classList.contains('is-center')
    }));
    tracksBuffer.push({
      name,
      kind: val('b-kind'),
      unitName: val('b-unit-name'),
      members,
      html: null
    });
    updateTracks(builderIsEditMode);
    closeBuilder(true);
  }

  function removeTrack(i, isEdit) {
    tracksBuffer.splice(i, 1);
    updateTracks(isEdit);
  }

  function updateTracks(isEdit) {
    const c = $(isEdit ? 'ed-tracks-list' : 'tracks-list');
    c.innerHTML = tracksBuffer.length ? '' : '<div style="text-align:center;color:#999;font-size:.85rem;">Vazio</div>';
    tracksBuffer.forEach((t, i) => {
      c.innerHTML += `<div class="track-item"><div class="track-info"><b>${t.name}</b> <span class="badge">${t.kind}</span></div><div class="track-actions"><button class="btn-icon" onclick="moveTrack(${i}, -1, ${isEdit})">‚¨Ü</button><button class="btn-icon" onclick="moveTrack(${i}, 1, ${isEdit})">‚¨á</button><button class="btn-icon delete" onclick="removeTrack(${i}, ${isEdit})">‚úï</button></div></div>`;
    });
  }

  function parsePartsSafe(text) {
    try {
      const x = JSON.parse(text || '[]');
      return Array.isArray(x) ? x : [];
    } catch (e) {
      return [];
    }
  }

  function normalizeParts(parts) {
    return (parts || []).map(p => ({
      discoId: p.discoId || null,
      single: p.single || p.Single || p.title || '(Sem single)',
      tracks: Array.isArray(p.tracks) ? p.tracks.map(t => ({
        title: t.title || t.name || '(Sem m√∫sica)',
        labels: Array.isArray(t.labels) ? t.labels : [],
        unitName: t.unitName || ''
      })) : []
    }));
  }

  function openPartEditor() {
    partEditorData = normalizeParts(parsePartsSafe(val('e-part')));
    $('part-editor-modal').style.display = 'flex';
    renderPartEditor();
  }

  function closePartEditor() {
    $('part-editor-modal').style.display = 'none';
  }

  function copyPartsToTextarea() {
    $('e-part').value = JSON.stringify(partEditorData, null, 0);
  }

  function purgeLegacyParticipations() {
    partEditorData = normalizeParts(parsePartsSafe(val('e-part')));
    partEditorData = partEditorData.filter(p => !!p.discoId);
    copyPartsToTextarea();
    alert("Limpo!");
  }

  function renderPartEditor() {
    const box = $('part-editor-list');
    const q = ($('part-search')?.value || '').trim().toLowerCase();
    const filtered = partEditorData.map((p, idx) => ({ p, idx }))
      .filter(({ p }) => !q || p.single.toLowerCase().includes(q));

    box.innerHTML = filtered.map(({ p, idx }) => {
      const trackHtml = (p.tracks || [])
        .map(t => `<div class="part-track"><div><b>${t.title}</b><small>${t.labels.join(', ')}</small></div></div>`)
        .join('');
      return `<div class="part-card">
                <div class="part-top">
                  <div class="part-title">${p.single}</div>
                  <button class="part-btn part-btn-danger" onclick="partEditorData.splice(${idx},1);renderPartEditor()">Apagar</button>
                </div>
                <div class="part-tracks">${trackHtml}</div>
              </div>`;
    }).join('');
  }

  function renderMemberSelectionList(filterText) {
    const gl = $('selection-list');
    if (!gl) return;
    const q = (filterText ?? $('member-search')?.value ?? '').toLowerCase().trim();
    const team = ($('member-filter-team')?.value || '').trim();

    const filtered = allMembers.filter(m => {
      if (m.status === 'Graduada' || m.status === 'Demitida' || m.status === 'Expulsa') return false;
      if (q && !m.name.toLowerCase().includes(q)) return false;
      if (team && m.team !== team) return false;
      return true;
    });

    gl.innerHTML = '';
    filtered.forEach(m => {
      const d = document.createElement('div');
      d.className = 'select-item';
      const p = resolveImage(m.photo) || 'https://placehold.co/100?text=?';
      d.innerHTML = `<img src="${p}" onerror="this.src='https://placehold.co/100?text=?'"><div>${m.name}</div>`;
      d.onclick = () => selectMember(m);
      gl.appendChild(d);
    });
  }

  // Init
  loadMembers();
  loadDiscos();
</script>

</body>
</html>
