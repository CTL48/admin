<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ZAP48 Admin (Master)</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { --primary: #8ACE00; --bg: #f4f6f8; }
    body { background: var(--bg); margin: 0; padding-bottom: 100px; font-family: 'Roboto', sans-serif; color: #333; }
    
    /* HEADER & NAV */
    .header { background: #000; padding: 15px; text-align: center; color: var(--primary); font-weight: 900; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,.1); display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
    .menu-toggle { display: none; background: none; border: none; color: var(--primary); font-size: 1.5rem; cursor: pointer; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: #000; display: flex; border-top: 4px solid var(--primary); z-index: 1000; }
    .nav-item { flex: 1; border: none; background: none; color: #666; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: .65rem; font-weight: 900; cursor: pointer; text-transform: uppercase; }
    .nav-item.active { color: var(--primary); }
    .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
    
    /* MOBILE MENU */
    .mobile-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: none; }
    .mobile-menu { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: #fff; z-index: 1002; transition: left 0.3s ease; padding-top: 60px; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
    .mobile-menu.open { left: 0; }
    .mobile-menu-item { display: block; padding: 15px 20px; color: #333; text-decoration: none; font-weight: 700; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .mobile-menu-item.active { background-color: #f0f0f0; color: #000; border-left: 5px solid var(--primary); }
    .mobile-menu-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #000; }
    @media (max-width: 768px) { .bottom-nav { display: none; } .menu-toggle { display: block; } body { padding-bottom: 0; } }

    /* LAYOUT & CARDS */
    .section { display: none; padding: 15px; animation: fadeIn .25s; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,.05); border: 1px solid #eee; }
    h2 { margin-top: 0; color: #000; font-weight: 900; }
    
    /* FORMS */
    label { display: block; font-size: .75rem; font-weight: 900; color: #666; margin-top: 14px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: .5px; }
    input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; background: #fff; font-size: 1rem; transition: .2s; color: #333; font-family: inherit; font-weight: 500; box-sizing: border-box; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; }
    textarea { resize: vertical; }
    .btn-main { width: 100%; padding: 15px; background: var(--primary); color: #000; border: 2px solid #000; border-radius: 8px; font-weight: 900; margin-top: 16px; font-size: 1rem; cursor: pointer; text-transform: uppercase; box-shadow: 4px 4px 0 #000; transition: transform 0.1s; }
    .btn-main:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }
    .btn-ghost { width: 100%; padding: 12px; border-radius: 8px; font-weight: 900; border: 2px solid #ddd; background: #fff; color: #555; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; }
    .input-group { display: flex; gap: 8px; align-items: center; margin-top: 5px; }
    .btn-upload { background: #333; color: #fff; border: none; padding: 12px 15px; border-radius: 8px; cursor: pointer; }
    .upload-status { font-size: .78rem; color: var(--primary); margin-top: 6px; font-weight: 900; min-height: 15px; }

    /* BUILDER & MODALS */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: none; flex-direction: column; overflow-y: auto; }
    .modal-overlay.active { display: flex; animation: slideUp .25s; }
    @keyframes slideUp { from { transform: translateY(100%) } to { transform: translateY(0) } }
    .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #fff; z-index: 10; }
    .modal-header button { border: none; background: none; font-size: 1.6rem; cursor: pointer; }
    .stage-area { padding: 20px; }
    .rows-panel { margin-top: 10px; padding: 12px; border: 1px solid #eee; border-radius: 12px; background: #fafafa; }
    .rows-panel .rowline { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
    .row-tag { min-width: 92px; font-size: .75rem; font-weight: 900; color: #444; text-transform: uppercase; }
    
    /* SLOTS (BOLINHAS) */
    .slots-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 18px; border: 2px dashed #ddd; margin-top: 15px; border-radius: 12px; background: #fafafa; }
    .rows-wrap { display: flex; flex-direction: column; gap: 14px; width: 100%; }
    .slots-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .slot { width: 74px; text-align: center; position: relative; cursor: pointer; transition: transform .2s; }
    .slot:active { transform: scale(.92); }
    .slot-circle { width: 64px; height: 64px; border-radius: 50%; background: #fff; border: 2px solid #ddd; display: flex; justify-content: center; align-items: center; margin: 0 auto; overflow: hidden; position: relative; }
    .slot.is-center .slot-circle { border-color: var(--primary); z-index: 2; box-shadow: 0 0 0 4px rgba(138, 206, 0, 0.4); transform: scale(1.05); }
    .slot-badge { position: absolute; bottom: 18px; right: 2px; background: #000; color: var(--primary); width: 20px; height: 20px; font-size: .65rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 5; border: 2px solid #fff; font-weight: 900; }
    .slot.is-center .slot-badge { background: var(--primary); color: #000; }
    .slot img { width: 100%; height: 100%; object-fit: cover; }
    .slot-name { font-size: .68rem; margin-top: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 900; }

    /* SELECTION POPUP */
    .popup-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, .8); z-index: 3000; display: none; justify-content: center; align-items: center; }
    .popup-box { background: #fff; width: 90%; max-height: 80vh; border-radius: 15px; padding: 20px; display: flex; flex-direction: column; }
    .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(78px, 1fr)); gap: 10px; overflow-y: auto; padding: 10px; }
    .select-item { text-align: center; cursor: pointer; padding: 6px; border-radius: 10px; transition: .2s; position: relative; user-select: none; border: 2px solid transparent; }
    .select-item:hover { background: #f5f5f5; }
    .select-item img { width: 66px; height: 66px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; }
    .select-item div { font-size: .72rem; font-weight: 900; margin-top: 6px; line-height: 1.15; }
    .select-item.is-picked { background: #efffde; border-color: var(--primary); }

    /* TRACK LIST */
    .track-item { background: #fff; padding: 10px 12px; border-radius: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .track-info { flex: 1; }
    .track-actions { display: flex; gap: 4px; align-items: center; }
    .btn-icon { border: none; background: #eee; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; }
    .btn-icon.delete { color: #fff; background: #f44336; }
    .badge { font-size: .72rem; font-weight: 900; border-radius: 999px; padding: 4px 10px; background: #000; color: var(--primary); text-transform: uppercase; display: inline-block; margin-left: 6px; }

    /* LOADER */
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, .95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0) } 100% { transform: rotate(360deg) } }
  </style>
</head>
<body>

  <div class="header">
      <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button> ZAP48 Admin <div style="width: 24px;"></div> 
  </div>

  <div class="mobile-menu-overlay" onclick="toggleMenu()"></div>
  <div class="mobile-menu" id="mobileMenu">
      <button class="mobile-menu-close" onclick="toggleMenu()">‚úï</button>
      <div class="mobile-menu-item" onclick="nav('news', this)"><i class="fas fa-plus-circle"></i> Add Not√≠cia</div>
      <div class="mobile-menu-item" onclick="nav('managenews', this)"><i class="fas fa-edit"></i> Edit Not√≠cia</div>
      <div class="mobile-menu-item" onclick="nav('disco', this)"><i class="fas fa-plus-circle"></i> Add M√∫sica</div>
      <div class="mobile-menu-item" onclick="nav('managedisco', this)"><i class="fas fa-edit"></i> Edit M√∫sica</div>
      <div class="mobile-menu-item" onclick="nav('members', this)"><i class="fas fa-user-plus"></i> Novo Membro</div>
      <div class="mobile-menu-item" onclick="nav('manage', this)"><i class="fas fa-user-edit"></i> Editar Membro</div>
  </div>

  <div id="loading-overlay">
    <div class="spinner"></div><div id="loading-text">Processando...</div>
  </div>

  <div id="tab-news" class="section">
    <div class="card">
      <h2>üì¢ Nova Not√≠cia</h2>
      <form onsubmit="saveNews(event)">
        <label>T√≠tulo</label><input id="n-title" required />
        <label>Categoria</label>
        <select id="n-cat"><option>Release</option><option>Event</option><option>Notice</option><option>Theater</option></select>
        <label>Data</label><input type="date" id="n-date" required />
        <label>Conte√∫do</label><textarea id="n-text" rows="5"></textarea>
        <button class="btn-main">Publicar</button>
      </form>
    </div>
  </div>

  <div id="tab-managenews" class="section">
      <div class="card">
          <h2>üì∞ Editar Not√≠cias</h2>
          <select id="news-selector" onchange="fillNewsEditForm()"><option value="">Carregando...</option></select>
          <div id="news-edit-form" style="display:none; margin-top:15px;">
              <form onsubmit="updateNews(event)">
                  <label>T√≠tulo</label><input id="en-title" required />
                  <label>Categoria</label>
                  <select id="en-cat"><option>Release</option><option>Event</option><option>Notice</option><option>Theater</option></select>
                  <label>Data</label><input type="date" id="en-date" required />
                  <label>Conte√∫do</label><textarea id="en-text" rows="5"></textarea>
                  <button class="btn-main" style="background:#2196f3; color:#fff; border-color:#2196f3;">Salvar Altera√ß√µes</button>
              </form>
              <button class="btn-main" style="background:#f44336; border-color:#f44336; color:#fff; margin-top:25px;" onclick="deleteNews()">Deletar Not√≠cia</button>
          </div>
      </div>
  </div>

  <div id="tab-disco" class="section active">
    <div class="card">
      <h2>üíø Adicionar M√∫sica</h2>
      <form onsubmit="saveDisco(event)">
        <label>T√≠tulo</label><input id="d-title" required placeholder="Ex: 10th Single" />
        <div style="display:flex; gap:10px;">
          <div style="flex:1"><label>Tipo</label><select id="d-type"><option>Single</option><option>Album</option><option>Stage</option></select></div>
          <div style="flex:1"><label>Data</label><input type="date" id="d-date" required /></div>
        </div>
        <label>Center (Auto)</label><input id="d-center" readonly style="background:#eee;" />
        <label>Capa (URL ou Upload)</label>
        <div class="input-group">
          <input id="d-cover" placeholder="https://..." required />
          <input type="file" id="d-cover-file" style="display:none" accept="image/*" onchange="uploadImage(this, 'd-cover', 'd-upload-status')" />
          <button type="button" class="btn-upload" onclick="document.getElementById('d-cover-file').click()"><i class="fas fa-upload"></i></button>
        </div>
        <div id="d-upload-status" class="upload-status"></div>
        <div style="margin-top:16px; border-top:1px solid #eee; padding-top:14px;">
          <label>M√∫sicas & Forma√ß√µes</label>
          <div id="tracks-list"><div style="text-align:center;color:#999;font-size:.85rem;">Vazio</div></div>
          <button type="button" class="btn-main" style="background:#333; color:#fff; border-color:#333; margin-top:10px;" onclick="openBuilder(false)">+ Adicionar Faixa</button>
        </div>
        <button class="btn-main">Salvar Tudo</button>
      </form>
    </div>
  </div>

  <div id="tab-managedisco" class="section">
    <div class="card">
      <h2>üóÇÔ∏è Editar M√∫sica</h2>
      <select id="disco-selector" onchange="fillDiscoEditForm()"><option value="">Carregando...</option></select>
      <div id="disco-edit-form" style="display:none; margin-top:15px;">
        <form onsubmit="updateDisco(event)">
          <label>T√≠tulo</label><input id="ed-title" readonly style="background:#eee; color:#777;" />
          <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Tipo</label><select id="ed-type"><option>Single</option><option>Album</option><option>Stage</option></select></div>
            <div style="flex:1"><label>Data</label><input type="date" id="ed-date" required /></div>
          </div>
          <label>Center (Auto)</label><input id="ed-center" />
          <label>Capa</label>
          <div class="input-group">
            <input id="ed-cover" required />
            <input type="file" id="ed-cover-file" style="display:none" accept="image/*" onchange="uploadImage(this, 'ed-cover', 'ed-upload-status')" />
            <button type="button" class="btn-upload" onclick="document.getElementById('ed-cover-file').click()"><i class="fas fa-upload"></i></button>
          </div>
          <div id="ed-upload-status" class="upload-status"></div>
          <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <label style="color:#2196f3;">Lista de M√∫sicas (Editar)</label>
            <div id="ed-tracks-list" style="margin-bottom:15px;"></div>
            <button type="button" class="btn-ghost" style="font-size:.9rem;" onclick="openBuilder(true)">+ Adicionar Nova M√∫sica</button>
          </div>
          <button class="btn-main" style="background:#2196f3; color:#fff; border-color:#2196f3;">Salvar Altera√ß√µes</button>
        </form>
        <button class="btn-main" style="background:#f44336; color:#fff; border-color:#f44336; margin-top:25px;" onclick="deleteDisco()">Deletar Disco (Cascade)</button>
      </div>
    </div>
  </div>

  <div id="tab-members" class="section">
    <div class="card">
      <h2>üë§ Novo Membro</h2>
      <form onsubmit="saveMember(event)">
        <label>Nome</label><input id="m-name" required />
        <div style="display:flex; gap:10px;">
          <div style="flex:1"><label>Time</label><select id="m-team" class="team-select"></select></div>
          <div style="flex:1"><label>Gera√ß√£o (N¬∫)</label><input type="number" id="m-gen" required placeholder="Ex: 1" /></div>
        </div>
        <label>Status</label><select id="m-status-select"><option value="Ativa">Ativa</option><option value="Graduada">Graduada</option><option value="Demitida">Demitida</option><option value="Expulsa">Expulsa</option></select>
        <label>Foto</label>
        <div class="input-group">
          <input id="m-photo" placeholder="https://..." required />
          <input type="file" id="m-photo-file" style="display:none" accept="image/*" onchange="uploadImage(this, 'm-photo', 'm-upload-status')" />
          <button type="button" class="btn-upload" onclick="document.getElementById('m-photo-file').click()"><i class="fas fa-upload"></i></button>
        </div>
        <div id="m-upload-status" class="upload-status"></div>
        <label>Biografia</label><textarea id="m-bio" rows="4"></textarea>
        <button class="btn-main">Cadastrar</button>
      </form>
    </div>
  </div>

  <div id="tab-manage" class="section">
    <div class="card">
      <h2>‚úèÔ∏è Editar Membro</h2>
      <input type="text" id="manage-search" class="search-input" placeholder="üîç Buscar membro..." oninput="renderManageSelect(this.value)" style="width:100%; padding:10px; margin-bottom:10px;" />
      <select id="manage-selector" onchange="fillEditForm()"><option value="">Carregando...</option></select>
      <div id="edit-form" style="display:none; margin-top:15px;">
        <img id="e-preview" src="" style="width:80px;height:80px;border-radius:50%; margin-bottom:10px; border:2px solid #eee;" />
        <form onsubmit="updateMember(event)">
          <label>Nome</label><input id="e-name" required />
          <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Time</label><select id="e-team" class="team-select"></select></div>
            <div style="flex:1"><label>Gera√ß√£o (N¬∫)</label><input type="number" id="e-gen" required /></div>
          </div>
          <label>Status</label><select id="e-status-select"><option value="Ativa">Ativa</option><option value="Graduada">Graduada</option><option value="Demitida">Demitida</option><option value="Expulsa">Expulsa</option></select>
          <label>Foto</label>
          <div class="input-group">
            <input id="e-photo" required onchange="document.getElementById('e-preview').src=this.value" />
            <input type="file" id="e-photo-file" style="display:none" accept="image/*" onchange="uploadImage(this, 'e-photo', 'e-upload-status')" />
            <button type="button" class="btn-upload" onclick="document.getElementById('e-photo-file').click()"><i class="fas fa-upload"></i></button>
          </div>
          <div id="e-upload-status" class="upload-status"></div>
          <label>Biografia</label><textarea id="e-bio" rows="5"></textarea>
          <label>Galeria (URLs - uma por linha)</label><textarea id="e-gallery" rows="5" placeholder="https://..."></textarea>
          <label>Participa√ß√µes (JSON ou Texto Simples)</label><textarea id="e-part" rows="3" placeholder='["Show A", "Show B"] ou apenas texto'></textarea>
          <button class="btn-main" style="background:#2196f3; color:#fff; border-color:#2196f3;">Salvar Altera√ß√µes</button>
        </form>
      </div>
    </div>
  </div>

  <div id="builder-modal" class="modal-overlay">
    <div class="modal-header"><span style="font-weight:900;">Forma√ß√£o</span><button onclick="closeBuilder(true)">‚úï</button></div>
    <div id="step-1" style="padding:20px; display:block;">
      <label>M√∫sica</label><input id="b-song" placeholder="Nome da faixa" />
      <label>Tipo</label><select id="b-kind" onchange="toggleKindRules()"><option value="A-side">A-side</option><option value="B-side">B-side</option><option value="Undergirls">Undergirls</option><option value="Unit">Unit</option><option value="Solo">Solo</option></select>
      <div id="unit-fields" style="display:none;"><label>Nome Unit</label><input id="b-unit-name" /></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
        <div><label>Total</label><input type="number" id="b-total" value="16" min="1" oninput="syncRowsUI()" /></div>
        <div><label>Centers</label><input type="number" id="b-centers" value="1" min="0" oninput="syncRowsUI()" /></div>
      </div>
      <div id="manual-rows" class="rows-panel">
        <label>Fileiras</label><select id="b-rowcount" onchange="renderRowInputs()"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option></select>
        <div id="row-inputs"></div>
        <div class="row-sum">Soma: <b id="rows-sum" style="color:#00b894;">16</b> / <b id="rows-total">16</b></div>
      </div>
      <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-top: 15px; border: 1px solid #bbdefb;">
          <label style="margin-top:0; color:#1565c0;">‚ú® Auto-preencher com Time</label>
          <select id="b-auto-team" class="team-select" style="margin-bottom:0;"></select>
          <div style="font-size:0.7rem; color:#666; margin-top:4px;">Seleciona membros ATIVOS deste time.</div>
      </div>
      <button class="btn-main" onclick="startStage()">Montar</button>
    </div>
    <div id="step-2" class="stage-area" style="display:none;">
      <div id="slots" class="slots-container"></div>
      <div style="display:flex; gap:10px; margin-top:16px;">
        <button type="button" class="btn-ghost" onclick="backToFormationMenu()">Voltar</button>
        <button type="button" class="btn-main" style="background:#6c5ce7; color:#fff; border-color:#6c5ce7; margin-top:0;" onclick="captureFormation()">Print</button>
        <button type="button" class="btn-main" style="background:#00b894; color:#fff; border-color:#00b894; margin-top:0;" onclick="finishTrack()">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="member-select-modal" class="popup-modal">
    <div class="popup-box">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><h3>Escolha</h3><button onclick="closeMemberModal()" style="border:none;background:none;font-size:1.5rem;">‚úï</button></div>
      <input id="member-search" class="search-input" placeholder="Buscar..." oninput="renderMemberSelectionList(this.value)" style="width:100%; padding:8px; margin-bottom:10px;" />
      <div id="selection-list" class="selection-grid"></div>
      <button onclick="clearSlot()" class="btn-main" style="background:#f44336; color:#fff; border-color:#f44336; margin-top:10px;">Remover (Vazio)</button>
    </div>
  </div>

  <div class="bottom-nav">
    <button class="nav-item active" onclick="nav('disco', this)"><i class="fas fa-compact-disc"></i>Disco</button>
    <button class="nav-item" onclick="nav('members', this)"><i class="fas fa-user-plus"></i>Add</button>
    <button class="nav-item" onclick="nav('manage', this)"><i class="fas fa-edit"></i>Edit</button>
    <button class="nav-item" onclick="nav('managedisco', this)"><i class="fas fa-folder-open"></i>Discos</button>
  </div>

  <script>
    // === CONFIGURA√á√ÉO E INIT ===
    const TEAM_CONFIG = { "Team Z": "Team Z", "Team AII": "Team AII", "Team P": "Team P", "Team Kenkyuusei": "Team Kenkyuusei", "Graduada": "Graduada" };
    const SUPABASE_URL = 'https://iooyygtaosshxygnhlco.supabase.co';
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlvb3l5Z3Rhb3NzaHh5Z25obGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDEyNTUsImV4cCI6MjA4NDU3NzI1NX0.gfcVtNgn3g1gnFVrtaIqzkWxajYiV_KbtycYsE9OZ0Y";
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const IMGBB_KEY = "81f7ca81cf22d739de576bd1dac7dcc2";
    const T_NEWS = "Noticias"; const T_DISCO = "Discografia"; const T_MEMBERS = "Membros";

    let allMembers=[], allDiscos=[], allNews=[], activeSlot=null, tracksBuffer=[], builderIsEditMode=false, currentEditingDiscoId=null, currentEditingNewsId=null;

    // === HELPERS DE DADOS ===

    function safeJsonParse(text) {
      const t = (text || "").trim();
      if (!t) return []; 
      try { return JSON.parse(t); } 
      catch (e) { return [t]; } 
    }
    
    function parseGallery(text) {
      return (text || "").split("\n").map(s => s.trim()).filter(Boolean);
    }

    // INIT
    async function init() {
        showLoading(true);
        populateTeamSelects();
        await loadMembers();
        await loadDiscos();
        await loadNews();
        showLoading(false);
    }

    // HELPERS UI
    function $(id) { return document.getElementById(id); }
    function val(id) { const el=$(id); return el?el.value:""; }
    function showLoading(show) { $('loading-overlay').style.display = show ? 'flex' : 'none'; }
    function nav(id, el) { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); $('tab-'+id).classList.add('active'); if(el)el.classList.add('active'); const m=$('mobileMenu'); if(m.classList.contains('open')) toggleMenu(); }
    function toggleMenu() { const m=$('mobileMenu'); const o=document.querySelector('.mobile-menu-overlay'); if(m.classList.contains('open')){m.classList.remove('open');o.style.display='none';}else{m.classList.add('open');o.style.display='block';} }
    
    function populateTeamSelects() { 
        document.querySelectorAll('.team-select').forEach(s=>{ 
            const emptyLabel = (s.id==='b-auto-team') ? 'Nenhum (Manual)' : 'Selecione...';
            s.innerHTML = `<option value="">${emptyLabel}</option>`; 
            for(let k in TEAM_CONFIG) s.innerHTML+=`<option value="${TEAM_CONFIG[k]}">${TEAM_CONFIG[k]}</option>`; 
        }); 
    }
    
    // DB LOADERS
    async function loadMembers() { 
        const {data, error} = await _supabase.from(T_MEMBERS).select('*').order('Nome'); 
        if(error) alert("Erro Membros: "+error.message);
        allMembers = data || []; 
        renderManageSelect(); 
    }
    async function loadDiscos() { const {data}=await _supabase.from(T_DISCO).select('*').order('Data',{ascending:false}); allDiscos=(data||[]).map(r=>({id:r.id, fields:r})); populateDiscoSelect(); }
    async function loadNews() { const {data}=await _supabase.from(T_NEWS).select('*').order('Data',{ascending:false}); allNews=data||[]; populateNewsSelect(); }
    function populateDiscoSelect() { const s=$('disco-selector'); s.innerHTML='<option value="">Selecione...</option>'; allDiscos.forEach(r=>s.innerHTML+=`<option value="${r.id}">${r.fields.Titulo}</option>`); }
    function populateNewsSelect() { const s=$('news-selector'); s.innerHTML='<option value="">Selecione...</option>'; allNews.forEach(n=>s.innerHTML+=`<option value="${n.id}">${n.Titulo}</option>`); }

    // UPLOAD
    async function uploadImage(input, targetId, statusId) {
      const f=input.files[0]; if(!f)return; $(statusId).innerText="‚è≥ Enviando...";
      try {
        const b64=await new Promise((r,j)=>{const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f);});
        const fd=new FormData(); fd.append("key", IMGBB_KEY); fd.append("image", String(b64).split(",")[1]);
        const res=await fetch("https://api.imgbb.com/1/upload", {method:"POST", body:fd}); const d=await res.json();
        if(!d.success)throw new Error("Erro");
        $(targetId).value=d.data.url; $(statusId).innerText="‚úÖ Ok!";
        if(targetId.includes('photo')) $('e-preview').src=d.data.url;
      } catch(e) { $(statusId).innerText="‚ùå Erro"; }
    }

    // ACTIONS: MEMBERS
    async function saveMember(e) { e.preventDefault(); showLoading(true);
        const d={Nome:$('m-name').value, Time:$('m-team').value, Geracao:$('m-gen').value+'¬™ Gera√ß√£o', Status:$('m-status-select').value, Perfil:$('m-bio').value, Foto:$('m-photo').value};
        await _supabase.from(T_MEMBERS).insert(d); await loadMembers(); $('m-name').value=''; alert("Salvo!"); showLoading(false);
    }

    async function updateMember(e) { 
        e.preventDefault(); 
        showLoading(true);
        
        try {
            const id=$('manage-selector').value; 
            
            // Dados para membros
            const d={
                Nome:$('e-name').value, 
                Time:$('e-team').value, 
                Geracao:$('e-gen').value+'¬™ Gera√ß√£o', 
                Status:$('e-status-select').value, 
                Perfil:$('e-bio').value, 
                Foto:$('e-photo').value,
                Galeria: parseGallery($('e-gallery').value),
                Participacoes: safeJsonParse($('e-part').value)
            };

            const { error } = await _supabase.from(T_MEMBERS).update(d).eq('id',id); 
            if(error) throw error;

            await loadMembers(); 
            alert("Atualizado com sucesso!"); 
        } catch(err) {
            console.error(err);
            alert("Erro ao atualizar: " + (err.message || err));
        } finally {
            showLoading(false);
        }
    }

    function renderManageSelect(q='') { const s=$('manage-selector'); const ov=s.value; s.innerHTML='<option value="">Selecione...</option>'; allMembers.filter(m=>m.Nome.toLowerCase().includes(q.toLowerCase())).forEach(m=>s.innerHTML+=`<option value="${m.id}">${m.Nome}</option>`); if(ov)s.value=ov; }
    
    function fillEditForm() { 
        const id=$('manage-selector').value; 
        const m=allMembers.find(x=>x.id==id); 
        if(!m){$('edit-form').style.display='none';return;} 
        
        $('edit-form').style.display='block'; 
        $('e-name').value=m.Nome; 
        $('e-team').value=m.Time; 
        $('e-gen').value=(m.Geracao||'').replace(/\D/g,''); 
        $('e-status-select').value=m.Status; 
        $('e-photo').value=m.Foto; 
        $('e-preview').src=m.Foto||'https://placehold.co/100?text=?'; 
        $('e-bio').value=m.Perfil||''; 

        const gal = m.Galeria || [];
        $('e-gallery').value = Array.isArray(gal) ? gal.join("\n") : "";

        const part = m.Participacoes;
        $('e-part').value = part ? JSON.stringify(part, null, 2) : "";
    }

    // ACTIONS: NEWS
    async function saveNews(e) { e.preventDefault(); showLoading(true);
        await _supabase.from(T_NEWS).insert({Titulo:$('n-title').value, Categoria:$('n-cat').value, Data:$('n-date').value, Texto:$('n-text').value});
        await loadNews(); $('n-title').value=''; $('n-text').value=''; alert("Publicado!"); showLoading(false);
    }
    function fillNewsEditForm() { const id=$('news-selector').value; const n=allNews.find(x=>x.id==id); if(!n){$('news-edit-form').style.display='none';return;} currentEditingNewsId=id; $('news-edit-form').style.display='block'; $('en-title').value=n.Titulo; $('en-cat').value=n.Categoria; $('en-date').value=n.Data; $('en-text').value=n.Texto; }
    async function updateNews(e) { e.preventDefault(); showLoading(true);
        await _supabase.from(T_NEWS).update({Titulo:$('en-title').value, Categoria:$('en-cat').value, Data:$('en-date').value, Texto:$('en-text').value}).eq('id',currentEditingNewsId);
        await loadNews(); alert("Atualizado!"); showLoading(false);
    }
    async function deleteNews() { if(!confirm("Deletar?"))return; showLoading(true); await _supabase.from(T_NEWS).delete().eq('id',currentEditingNewsId); await loadNews(); $('news-edit-form').style.display='none'; alert("Deletado!"); showLoading(false); }

    // === L√ìGICA DE SINCRONIZA√á√ÉO MEMBROS/DISCO (CORRIGIDA) ===
    
    async function syncMemberParticipations(discoTitle, tracksBuffer) {
        // 1. Organiza quais membros est√£o em quais faixas
        const memberUpdates = {}; 

        tracksBuffer.forEach(track => {
            if(track.members && Array.isArray(track.members)){
                track.members.forEach(m => {
                    if (!memberUpdates[m.id]) memberUpdates[m.id] = [];
                    
                    // Cria o objeto da m√∫sica (Track)
                    // Define Labels com base no tipo e se √© Center
                    const labels = [track.kind]; // Ex: "A-side"
                    if (m.isCenter) labels.push("Center");
                    
                    memberUpdates[m.id].push({
                        title: track.name,
                        labels: labels
                    });
                });
            }
        });

        // 2. Processa cada membro
        const promises = Object.keys(memberUpdates).map(async (memberId) => {
            const member = allMembers.find(am => am.id == memberId);
            if (!member) return;

            const newTracks = memberUpdates[memberId];

            // L√™ o JSON atual do membro
            let currentPart = member.Participacoes || [];
            if (typeof currentPart === 'string') {
                 try { currentPart = JSON.parse(currentPart); } catch(e) { currentPart = []; }
            }
            if (!Array.isArray(currentPart)) currentPart = [];

            // 3. Atualiza ou Adiciona o Single
            // Primeiro, removemos a entrada antiga deste Single (se existir) para atualizar limpo
            currentPart = currentPart.filter(p => p.single !== discoTitle);

            // Adiciona a nova estrutura JSON completa
            currentPart.push({
                single: discoTitle,
                tracks: newTracks
            });

            // 4. Salva no banco
            return _supabase.from(T_MEMBERS).update({ Participacoes: currentPart }).eq('id', memberId);
        });

        await Promise.all(promises);
    }

    // ACTIONS: DISCO (COM SYNC ATUALIZADO)
    async function saveDisco(e) { e.preventDefault(); if(!tracksBuffer.length)return alert("Adicione m√∫sicas"); showLoading(true);
        const html=buildHTML(); 
        const c=tracksBuffer[0]?(tracksBuffer[0].members||[]).filter(m=>m.isCenter).map(m=>m.name).join('&'):'';
        const title = $('d-title').value;

        // Salva Discografia
        await _supabase.from(T_DISCO).insert({
            Titulo: title, 
            Tipo:$('d-type').value, 
            Center:c, 
            Data:$('d-date').value, 
            Capa:$('d-cover').value, 
            Tracklist:html,
            Participacoes: tracksBuffer
        });

        // Atualiza Membros (Agora com JSON correto)
        await syncMemberParticipations(title, tracksBuffer);
        
        await loadDiscos(); await loadMembers(); 
        $('d-title').value=''; tracksBuffer=[]; updateTracks(false); 
        alert("Disco Salvo e Participa√ß√µes JSON Atualizadas!"); 
        showLoading(false);
    }

    function fillDiscoEditForm() { 
        const id=$('disco-selector').value; 
        const r=allDiscos.find(x=>x.id==id); 
        if(!r){$('disco-edit-form').style.display='none';return;} 
        currentEditingDiscoId=id; 
        
        $('disco-edit-form').style.display='block'; 
        $('ed-title').value=r.fields.Titulo; 
        $('ed-type').value=r.fields.Tipo; 
        $('ed-date').value=r.fields.Data; 
        $('ed-center').value=r.fields.Center; 
        $('ed-cover').value=r.fields.Capa; 
        
        tracksBuffer = r.fields.Participacoes || parseHTMLToTracks(r.fields.Tracklist||''); 
        updateTracks(true); 
    }

    async function updateDisco(e) { e.preventDefault(); showLoading(true);
        const html=buildHTML(); 
        const c=tracksBuffer[0]?(tracksBuffer[0].members||[]).filter(m=>m.isCenter).map(m=>m.name).join('&'):'';
        const title = $('ed-title').value;
        
        await _supabase.from(T_DISCO).update({
            Tipo:$('ed-type').value, 
            Data:$('ed-date').value, 
            Center:c, 
            Capa:$('ed-cover').value, 
            Tracklist:html,
            Participacoes: tracksBuffer
        }).eq('id',currentEditingDiscoId);
        
        // Atualiza Membros tamb√©m na edi√ß√£o (JSON Correto)
        await syncMemberParticipations(title, tracksBuffer);

        await loadDiscos(); await loadMembers(); 
        alert("Disco Atualizado e Participa√ß√µes Sincronizadas!"); 
        showLoading(false);
    }

    async function deleteDisco() { if(!confirm("Deletar?"))return; showLoading(true); await _supabase.from(T_DISCO).delete().eq('id',currentEditingDiscoId); await loadDiscos(); $('disco-edit-form').style.display='none'; alert("Deletado!"); showLoading(false); }

    // BUILDER LOGIC
    function openBuilder(isEdit) { builderIsEditMode=isEdit; $('builder-modal').style.display='flex'; $('step-1').style.display='block'; $('step-2').style.display='none'; if(!$('row-inputs').children.length) renderRowInputs(); $('b-song').value=''; $('b-auto-team').value=''; syncRowsUI(); }
    function closeBuilder() { $('builder-modal').style.display='none'; }
    function backToFormationMenu() { $('step-2').style.display='none'; $('step-1').style.display='block'; }
    function syncRowsUI() { $('rows-total').innerText = parseInt(val('b-total'))||0; updateRowsSum(); }
    function renderRowInputs() { const w=$('row-inputs'), c=parseInt(val('b-rowcount'))||3; w.innerHTML=''; for(let i=0;i<c;i++) w.innerHTML+=`<div class="rowline"><div class="row-tag">${i===0?'Frente':(i===c-1?'Fundo':`Meio ${i}`)}</div><input type="number" min="0" class="row-count-input" value="0" oninput="updateRowsSum()"></div>`; updateRowsSum(); }
    function updateRowsSum() { const s=[...document.querySelectorAll('.row-count-input')].reduce((a,b)=>a+(parseInt(b.value)||0),0); $('rows-sum').innerText=s; $('rows-sum').style.color=(s===(parseInt(val('b-total'))||0))?'#00b894':'#e91e63'; }
    function toggleKindRules() { const k=val('b-kind'); $('unit-fields').style.display=(k==='Unit')?'block':'none'; }
    
    function startStage() {
        const t=parseInt(val('b-total'))||0, inps=[...document.querySelectorAll('.row-count-input')].map(i=>parseInt(i.value)||0);
        if(inps.reduce((a,b)=>a+b,0)!==t) return alert("Soma incorreta.");
        const c=parseInt(val('b-centers'))||0, autoTeam=$('b-auto-team').value;
        let ci=[], membersToFill=[];
        if(c>0&&inps[0]>0) { const s=Math.floor((inps[0]-c)/2); for(let k=0;k<c;k++) ci.push(s+k); }
        
        // Auto-Fill Logic
        if(autoTeam) membersToFill=allMembers.filter(m=>m.Time===autoTeam && ['Ativa'].includes(m.Status));
        let fillIdx=0;

        $('slots').innerHTML=''; const rw=document.createElement('div'); rw.className='rows-wrap';
        
        for(let r=inps.length-1;r>=0;r--){
            const rd=document.createElement('div'); rd.className='slots-row'; const isF=(r===0);
            let startB=1; for(let k=0;k<r;k++) startB+=inps[k];
            
            for(let j=0;j<inps[r];j++){
                const d=document.createElement('div'); d.className='slot'; if(isF&&ci.includes(j))d.classList.add('is-center');
                let inner=`<div class="slot-badge">${startB+j}</div><div class="slot-circle"><i class="fas fa-plus" style="color:#ddd"></i></div><div class="slot-name">-</div>`;
                
                let assigned=null;
                if(autoTeam && fillIdx<membersToFill.length) {
                    assigned=membersToFill[fillIdx++]; const p=assigned.Foto||'https://placehold.co/100?text=?';
                    inner=`<div class="slot-badge">${startB+j}</div><div class="slot-circle"><img src="${p}"></div><div class="slot-name">${assigned.Nome}</div>`;
                }
                d.innerHTML=inner; if(assigned){ d.dataset.id=assigned.id; d.dataset.name=assigned.Nome; d.dataset.gen=assigned.Geracao; }
                d.onclick=()=>openMemberModal(d); rd.appendChild(d);
            }
            rw.appendChild(rd);
        }
        $('slots').appendChild(rw); $('step-1').style.display='none'; $('step-2').style.display='block';
    }

    function openMemberModal(el) { activeSlot=el; $('member-select-modal').style.display='flex'; renderMemberSelectionList(''); }
    function closeMemberModal() { $('member-select-modal').style.display='none'; activeSlot=null; }
    function selectMember(m) { if(!activeSlot)return; activeSlot.querySelector('.slot-circle').innerHTML=`<img src="${m.Foto}">`; activeSlot.querySelector('.slot-name').innerText=m.Nome; activeSlot.dataset.id=m.id; activeSlot.dataset.name=m.Nome; activeSlot.dataset.gen=m.Geracao; closeMemberModal(); }
    function clearSlot() { if(activeSlot){activeSlot.querySelector('.slot-circle').innerHTML='<i class="fas fa-plus"></i>';activeSlot.querySelector('.slot-name').innerText='-';delete activeSlot.dataset.id;} closeMemberModal(); }
    async function captureFormation() { const c=await html2canvas($('slots'),{backgroundColor:"#fafafa",scale:2}); const a=document.createElement('a'); a.href=c.toDataURL(); a.download='formation.png'; a.click(); }
    function finishTrack() {
        const n=val('b-song').trim(); if(!n) return alert("Nome?");
        const s=[...document.querySelectorAll('.slot')].filter(el=>el.dataset.id).map(el=>({id:el.dataset.id,name:el.dataset.name,gen:el.dataset.gen,isCenter:el.classList.contains('is-center')}));
        if(!s.length) return alert("Vazio?");
        tracksBuffer.push({name:n, kind:val('b-kind'), unitName:val('b-unit-name'), members:s, html:null});
        updateTracks(builderIsEditMode); closeBuilder();
    }
    function updateTracks(isEdit) { const c=$(isEdit?'ed-tracks-list':'tracks-list'); c.innerHTML=tracksBuffer.map((t,i)=>`<div class="track-item"><div class="track-info"><b>${t.name}</b> <span class="badge">${t.kind}</span></div><div class="track-actions"><button type="button" class="btn-icon delete" onclick="tracksBuffer.splice(${i},1);updateTracks(${isEdit})">‚úï</button></div></div>`).join('') || '<div style="text-align:center;color:#999;">Vazio</div>'; }
    
    function renderMemberSelectionList(q='') { 
        const gl=$('selection-list'); gl.innerHTML=''; 
        allMembers.filter(m => (!q || m.Nome.toLowerCase().includes(q.toLowerCase()))).forEach(m=>{
            const d=document.createElement('div'); d.className='select-item';
            const p = m.Foto || 'https://placehold.co/100?text=?';
            d.innerHTML=`<img src="${p}"><div>${m.Nome}</div>`;
            d.onclick=()=>selectMember(m);
            gl.appendChild(d);
        }); 
    }
    
    // HTML GENERATORS
    function buildHTML() { 
        let h=`<div class="modal-nav"><button class="modal-nav-btn active">Tracklist</button></div><div class="details-content"><ol class="tracklist">`;
        let f=`<div class="modal-section">`;
        tracksBuffer.forEach(t=>{
            h+=`<li><a>${t.name}</a> <span class="label ${normalizeKind(t.kind)}">${t.kind}</span></li>`;
            f+=`<div class="formation-group"><div class="formation-title">${t.name}</div><div class="member-grid">` + 
                (t.members||[]).map(m=>`<a class="member-card-static ${m.isCenter?'is-center':''}"><div class="member-photo"><img src="${allMembers.find(am=>am.id==m.id)?.Foto||'https://placehold.co/100'}"></div><div class="member-info"><h3>${m.name}</h3><p>${m.gen}</p></div></a>`).join('') + `</div></div><hr>`;
        });
        return h+`</ol></div>`+f+`</div><div id="ctl48-formation-data" style="display:none;">${JSON.stringify(tracksBuffer)}</div>`;
    }
    function normalizeKind(k){const s=(k||'').toLowerCase(); return s.includes('a-side')?'a-side':s.includes('under')?'undergirls':s.includes('unit')?'unit':'b-side';}
    function parseHTMLToTracks(h){const d=document.createElement('div');d.innerHTML=h;const e=d.querySelector('#ctl48-formation-data');return e?JSON.parse(e.innerText):[];}

    // Call Init
    init();
  </script>
</body>
</html>
