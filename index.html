<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CTL48 Admin v29 (Search Added)</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root { --primary: #e91e63; --bg: #f4f6f8; --card: #fff; }
    body { background:var(--bg); margin:0; padding-bottom:100px; font-family:'Roboto', sans-serif; color:#333; }
    .header { background: linear-gradient(135deg, var(--primary), #ff5f9e); padding:15px; text-align:center; color:white; font-weight:900; position:sticky; top:0; z-index:100; box-shadow:0 4px 10px rgba(0,0,0,0.1); }

    .section { display:none; padding:15px; animation:fadeIn 0.25s; }
    .section.active { display:block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    .card { background:white; padding:20px; border-radius:12px; margin-bottom:15px; box-shadow:0 2px 10px rgba(0,0,0,0.05); }

    label { display:block; font-size:0.85rem; font-weight:900; color:#444; margin-top:12px; margin-bottom:6px; text-align:left; text-transform:uppercase; letter-spacing:.4px; }
    input, select, textarea {
      width:100%; padding:12px; border:1px solid #ddd; border-radius:10px;
      background:#fff; font-size:1rem; transition:.2s; color:#333;
      appearance: none; -webkit-appearance: none;
    }
    textarea { resize:vertical; }

    .btn-main { width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:50px; font-weight:900; margin-top:16px; font-size:1rem; cursor:pointer; }
    .btn-main:active { transform:scale(.98); }
    
    .btn-ghost{ width:100%; padding:15px; border-radius:50px; font-weight:900; border:2px solid #333; background:#fff; color:#333; cursor:pointer; }
    .btn-ghost:active{ transform:scale(.98); }

    .input-group { display:flex; gap:8px; align-items:center; margin-top:5px; }
    .input-group input { margin-top:0; }
    .btn-upload { background:#333; color:white; border:none; padding:12px 15px; border-radius:10px; cursor:pointer; white-space:nowrap; }
    .btn-upload i { font-size:1.1rem; }
    .upload-status { font-size:0.78rem; color:#e91e63; margin-top:6px; font-weight:900; min-height:15px; }

    /* NAV */
    .bottom-nav { position:fixed; bottom:0; width:100%; height:70px; background:white; display:flex; border-top:1px solid #eee; z-index:1000; }
    .nav-item { flex:1; border:none; background:none; color:#999; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:0.7rem; font-weight:900; }
    .nav-item.active { color:var(--primary); }
    .nav-item i { font-size:1.4rem; margin-bottom:4px; }

    /* LOADING */
    #loading-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.92); z-index:5000; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
    .spinner { border:5px solid #f3f3f3; border-top:5px solid var(--primary); border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin-bottom:20px; }
    @keyframes spin { 0% { transform:rotate(0deg);} 100% { transform:rotate(360deg);} }
    #loading-text { font-weight:900; color:var(--primary); }
    #loading-log { font-size:0.85rem; color:#666; margin-top:10px; max-height:140px; overflow-y:auto; width:86%; }

    /* BUILDER MODAL */
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; display:none; flex-direction:column; overflow-y:auto; }
    .modal-overlay.active { display:flex; animation:slideUp .25s; }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

    .modal-header { padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; background:white; z-index:10; }
    .modal-header button{ border:none; background:none; font-size:1.6rem; cursor:pointer; }

    .stage-area{ padding:20px; }
    .builder-topnote{ text-align:center; font-weight:900; color:#e91e63; font-size:0.9rem; margin-bottom:12px; }

    /* MANUAL ROWS PANEL */
    .rows-panel{ margin-top:10px; padding:12px; border:1px solid #eee; border-radius:12px; background:#fafafa; }
    .rows-panel .rowline{ display:flex; gap:10px; align-items:center; margin-top:10px; }
    .row-tag{ min-width:92px; font-size:0.75rem; font-weight:900; color:#444; text-transform:uppercase; letter-spacing:.4px; }
    .row-sum{ margin-top:10px; font-size:0.85rem; font-weight:900; color:#666; }
    .row-sum b{ color:#e91e63; }

    /* Formation rendering */
    .slots-container { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; padding:18px; border:2px dashed #ddd; margin-top:15px; border-radius:12px; background:#fafafa; }
    .rows-wrap{ display:flex; flex-direction:column; gap:14px; width: 100%; }
    .slots-row{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }

    .slot { width:74px; text-align:center; position:relative; cursor:pointer; transition:transform .2s; }
    .slot:active { transform:scale(.92); }
    .slot-circle { width:64px; height:64px; border-radius:50%; background:white; border:2px solid #ddd; display:flex; justify-content:center; align-items:center; margin:0 auto; overflow:hidden; transition:.2s; position:relative; }
    
    /* Visual de Center ATIVO */
    .slot.is-center .slot-circle { 
        border-color: #e91e63; 
        z-index: 2; 
        box-shadow: 0 0 0 4px rgba(233, 30, 99, 0.4);
        transform: scale(1.05);
    }
    
    .slot-badge { position:absolute; bottom:18px; right:2px; background:#333; color:white; width:20px; height:20px; font-size:.65rem; border-radius:50%; display:flex; align-items:center; justify-content:center; z-index:5; border:2px solid white; font-weight:900; }
    .slot.is-center .slot-badge { background:#e91e63; }
    .slot img { width:100%; height:100%; object-fit:cover; }
    .slot-name { font-size:0.68rem; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:900; }

    /* MEMBER PICKER */
    .selection-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; display:none; justify-content:center; align-items:center; }
    .selection-box { background:white; width:90%; max-height:80vh; border-radius:15px; padding:20px; display:flex; flex-direction:column; }
    .selection-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(78px, 1fr)); gap:10px; overflow-y:auto; padding:10px; }
    .select-item { text-align:center; cursor:pointer; padding:6px; border-radius:10px; transition:.2s; }
    .select-item:hover { background:#f5f5f5; }
    .select-item img { width:66px; height:66px; border-radius:50%; object-fit:cover; border:2px solid #eee; }
    .select-item div { font-size:0.72rem; font-weight:900; margin-top:6px; line-height:1.15; }

    /* tracks list */
    .track-item { background:#fff0f5; padding:12px; border-radius:10px; margin-top:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #ffc1e3; }
    .track-center-badge { font-size:0.78rem; color:#e91e63; font-weight:900; }
    .track-badges { display:flex; gap:6px; flex-wrap:wrap; }
    .badge { font-size:.72rem; font-weight:900; border-radius:999px; padding:4px 10px; background:#333; color:#fff; text-transform:uppercase; letter-spacing:.3px; }
    
    /* SEARCH INPUTS */
    .search-input { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-weight:700; margin-bottom:10px; font-size:0.9rem; }
  </style>
</head>
<body>

  <div class="header">CTL48 Admin v29</div>

  <div id="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <div id="loading-text">Processando...</div>
    <div id="loading-log"></div>
  </div>

  <div id="tab-news" class="section">
    <div class="card">
      <h2>üì¢ Nova Not√≠cia</h2>
      <form onsubmit="saveNews(event)">
        <label>T√≠tulo</label><input id="n-title" required>
        <label>Categoria</label>
        <select id="n-cat"><option>Release</option><option>Event</option><option>Notice</option><option>Theater</option></select>
        <label>Data</label><input type="date" id="n-date" required>
        <label>Conte√∫do</label><textarea id="n-text" rows="5"></textarea>
        <button class="btn-main">Publicar</button>
      </form>
    </div>
  </div>

  <div id="tab-disco" class="section active">
    <div class="card">
      <h2>üíø Discografia</h2>
      <div style="background:#fff0f5; color:#c2185b; padding:10px; border-radius:8px; font-size:0.8rem; margin-bottom:15px; border:1px solid #f8bbd0;">
        üí° Ao salvar, o sistema atualizar√° automaticamente o perfil de todos os membros e gerar√° o layout bonito para o App.
      </div>
      <form onsubmit="saveDisco(event)">
        <label>T√≠tulo</label><input id="d-title" required placeholder="Ex: 10th Single">
        <div style="display:flex; gap:10px;">
          <div style="flex:1">
            <label>Tipo</label>
            <select id="d-type"><option>Single</option><option>Album</option><option>Stage</option></select>
          </div>
          <div style="flex:1">
            <label>Data</label><input type="date" id="d-date" required>
          </div>
        </div>

        <label>Center (Autom√°tico)</label>
        <input id="d-center" placeholder="Autom√°tico..." readonly style="background:#eee;">

        <label>Capa (URL ou Upload)</label>
        <div class="input-group">
          <input id="d-cover" placeholder="https://..." required>
          <input type="file" id="d-cover-file" style="display:none" accept="image/*" onchange="uploadImage(this, 'd-cover', 'd-upload-status')">
          <button type="button" class="btn-upload" onclick="document.getElementById('d-cover-file').click()"><i class="fas fa-upload"></i></button>
        </div>
        <div id="d-upload-status" class="upload-status"></div>

        <div style="margin-top:16px; border-top:1px solid #eee; padding-top:14px;">
          <label>M√∫sicas & Forma√ß√µes</label>
          <div id="tracks-list"><div style="text-align:center;color:#999;font-size:0.85rem;">Vazio</div></div>
          <button type="button" class="btn-main" style="background:#333; margin-top:10px;" onclick="openBuilder()">+ Adicionar M√∫sica</button>
        </div>

        <button class="btn-main">Salvar Tudo</button>
      </form>
    </div>
  </div>

  <div id="tab-members" class="section">
    <div class="card">
      <h2>üë§ Novo Membro</h2>
      <form onsubmit="saveMember(event)">
        <label>Nome</label><input id="m-name" required>
        <div style="display:flex; gap:10px;">
          <div style="flex:1">
            <label>Time</label>
            <select id="m-team"><option>Team C</option><option>Team T</option><option>Team L</option><option>Team Kenkyuusei</option></select>
          </div>
          <div style="flex:1">
            <label>Gera√ß√£o (N¬∫)</label><input type="number" id="m-gen" required placeholder="Ex: 1">
          </div>
        </div>
        
        <label>Status</label>
        <select id="m-status-select">
            <option value="Ativa">Ativa</option>
            <option value="Graduada">Graduada</option>
            <option value="Demitida">Demitida</option>
            <option value="Expulsa">Expulsa</option>
        </select>

        <label>Foto (URL ou Upload)</label>
        <div class="input-group">
          <input id="m-photo" placeholder="https://..." required>
          <input type="file" id="m-photo-file" style="display:none" accept="image/*" onchange="uploadImage(this, 'm-photo', 'm-upload-status')">
          <button type="button" class="btn-upload" onclick="document.getElementById('m-photo-file').click()"><i class="fas fa-upload"></i></button>
        </div>
        <div id="m-upload-status" class="upload-status"></div>
        <label>Biografia</label>
        <textarea id="m-bio" rows="4" placeholder="Escreva a biografia da integrante..."></textarea>

        <button class="btn-main">Cadastrar</button>
      </form>
    </div>
  </div>

  <div id="tab-manage" class="section">
    <div class="card">
      <h2>‚úèÔ∏è Editar Membro</h2>
      
      <input type="text" id="manage-search" class="search-input" placeholder="üîç Buscar membro para editar..." oninput="renderManageSelect(this.value)">
      <select id="manage-selector" onchange="fillEditForm()"><option value="">Carregando...</option></select>

      <div id="edit-form" style="display: none; margin-top: 15px;">
        <img id="e-preview" src="" style="width:80px;height:80px;border-radius:50%; margin-bottom:10px; border:2px solid #eee;">
        <form onsubmit="updateMember(event)">
          <label>Nome</label><input id="e-name" required>

          <div style="display:flex; gap:10px;">
            <div style="flex:1">
              <label>Time</label>
              <select id="e-team"><option>Team C</option><option>Team T</option><option>Team L</option><option>Team Kenkyuusei</option></select>
            </div>
            <div style="flex:1">
              <label>Gera√ß√£o (N¬∫)</label><input type="number" id="e-gen" required placeholder="Ex: 1">
            </div>
          </div>

          <label>Status</label>
          <select id="e-status-select">
            <option value="Ativa">Ativa</option>
            <option value="Graduada">Graduada</option>
            <option value="Demitida">Demitida</option>
            <option value="Expulsa">Expulsa</option>
          </select>

          <label>Foto (URL ou Upload)</label>
          <div class="input-group">
            <input id="e-photo" required onchange="document.getElementById('e-preview').src=this.value">
            <input type="file" id="e-photo-file" style="display:none" accept="image/*" onchange="uploadImage(this, 'e-photo', 'e-upload-status')">
            <button type="button" class="btn-upload" onclick="document.getElementById('e-photo-file').click()"><i class="fas fa-upload"></i></button>
          </div>
          <div id="e-upload-status" class="upload-status"></div>
          
          <label>Biografia</label>
          <textarea id="e-bio" rows="5" placeholder="Escreva a biografia..."></textarea>

          <label>Galeria (URLs, 1 por linha)</label>
          <textarea id="e-gallery" rows="5" placeholder="https://...&#10;https://..."></textarea>

          <label>Upload Fotos (galeria)</label>
          <div class="input-group">
            <input type="file" id="e-gallery-files" hidden accept="image/*" multiple onchange="uploadGalleryFiles(this)">
            <button type="button" class="btn-upload" onclick="document.getElementById('e-gallery-files').click()">
              <i class="fas fa-images"></i>
            </button>
          </div>
          <div id="e-gallery-status" class="upload-status"></div>

          <label>Participa√ß√µes (JSON)</label>
          <textarea id="e-part" rows="3"></textarea>

          <button class="btn-main" style="background:#2196f3;">Salvar Altera√ß√µes</button>
        </form>
      </div>
    </div>
  </div>

  <div id="tab-managedisco" class="section">
    <div class="card">
      <h2>üóÇÔ∏è Gerenciar Discografia</h2>
      <label>Selecionar disco</label>
      <select id="disco-selector" onchange="fillDiscoEditForm()">
        <option value="">Carregando...</option>
      </select>

      <div id="disco-edit-form" style="display:none; margin-top:15px;">
        <form onsubmit="updateDisco(event)">
          <label>T√≠tulo</label><input id="ed-title" required readonly style="background:#eee; color:#777;">
          <div style="font-size:0.75rem; color:#e91e63; margin-bottom:10px;">* T√≠tulo n√£o pode ser alterado para garantir a integridade do hist√≥rico.</div>
          
          <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>Tipo</label><select id="ed-type"><option>Single</option><option>Album</option><option>Stage</option></select></div>
            <div style="flex:1"><label>Data</label><input type="date" id="ed-date" required></div>
          </div>
          <label>Center</label><input id="ed-center">
          <label>Capa (URL)</label>
          <div class="input-group">
            <input id="ed-cover" placeholder="https://..." required>
            <input type="file" id="ed-cover-file" hidden accept="image/*" onchange="uploadImage(this, 'ed-cover', 'ed-upload-status')">
            <button type="button" class="btn-upload" onclick="document.getElementById('ed-cover-file').click()"><i class="fas fa-upload"></i></button>
          </div>
          <div id="ed-upload-status" class="upload-status"></div>
          
          <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
             <label>M√∫sicas (Detectadas)</label>
             <div id="ed-tracks-list" style="margin-bottom:10px;"></div>
             <button type="button" class="btn-ghost" style="font-size:0.8rem; padding:10px;" onclick="openBuilder()">+ Adicionar Nova M√∫sica</button>
          </div>

          <label>Tipo da faixa (Calculado ao Salvar)</label><input id="ed-tipos" placeholder="Ex: A-side, B-side">
          <textarea id="ed-tracklist" style="display:none;"></textarea>

          <button class="btn-main" style="background:#2196f3;">Salvar Altera√ß√µes (Regerar HTML)</button>
        </form>

        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <p style="color:#f44336; font-weight:bold; font-size:0.9rem;">Zona de Perigo</p>
            <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Ao deletar este disco, ele ser√° removido do hist√≥rico de todos os membros.</p>
            <button class="btn-main" style="background:#f44336; margin-top:0;" onclick="deleteDisco()">Deletar Disco (Cascade)</button>
        </div>
      </div>
    </div>
  </div>

  <div id="builder-modal" class="modal-overlay" style="display: none;">
    <div class="modal-header">
      <span style="font-weight:900;">Forma√ß√£o</span>
      <button onclick="closeBuilder(true)">‚úï</button>
    </div>
    <div id="step-1" style="padding: 20px; display: block;">
      <label>M√∫sica</label><input id="b-song" placeholder="Nome da faixa">
      <label>Tipo da faixa</label>
      <select id="b-kind" onchange="toggleKindRules()">
        <option value="A-side">A-side</option><option value="B-side">B-side</option><option value="Undergirls">Undergirls</option><option value="Unit">Unit</option><option value="Solo">Solo</option>
      </select>
      <div id="unit-fields" style="display:none;"><label>Nome da Unit</label><input id="b-unit-name" placeholder="Ex: Under Girls"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
        <div><label>Total (Membros)</label><input type="number" id="b-total" value="16" min="1" oninput="syncRowsUI()"></div>
        <div><label>Centers</label><input type="number" id="b-centers" value="1" min="0" oninput="syncRowsUI()"></div>
      </div>
      <div id="manual-rows" class="rows-panel">
        <label>Quantidade de fileiras</label>
        <select id="b-rowcount" onchange="renderRowInputs()"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option></select>
        <div id="row-inputs"></div>
        <div class="row-sum">Soma: <b id="rows-sum" style="color: rgb(0, 184, 148);">16</b> / <b id="rows-total">16</b></div>
      </div>
      <button class="btn-main" onclick="startStage()">Montar</button>
    </div>
    <div id="step-2" class="stage-area" style="display: none;">
      <div class="builder-topnote">Toque na bolinha para escolher!</div>
      <div id="slots" class="slots-container"></div>
      <div style="display:flex; gap:10px; margin-top:16px;">
        <button type="button" class="btn-ghost" onclick="backToFormationMenu()">Voltar</button>
        <button type="button" class="btn-main" style="background:#6c5ce7; margin-top:0;" onclick="captureFormation()">Print</button>
        <button type="button" class="btn-main" style="background:#00b894; margin-top:0;" onclick="finishTrack()">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="member-select-modal" class="selection-modal" style="display: none;">
    <div class="selection-box">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3 style="margin:0;">Escolha</h3>
        <button onclick="closeMemberModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">‚úï</button>
      </div>
      
      <input id="member-search" class="search-input" placeholder="Buscar membro..." oninput="renderMemberSelectionList(this.value)">
      
      <div id="selection-list" class="selection-grid"></div>
      <button onclick="clearSlot()" class="btn-main" style="background:#f44336; margin-top:10px;">Remover (Vazio)</button>
    </div>
  </div>

  <div class="bottom-nav">
    <button class="nav-item" onclick="nav('news', this)"><i class="fas fa-newspaper"></i>News</button>
    <button class="nav-item active" onclick="nav('disco', this)"><i class="fas fa-compact-disc"></i>Disco</button>
    <button class="nav-item" onclick="nav('members', this)"><i class="fas fa-user-plus"></i>Add</button>
    <button class="nav-item" onclick="nav('manage', this)"><i class="fas fa-edit"></i>Edit</button>
    <button class="nav-item" onclick="nav('managedisco', this)"><i class="fas fa-folder-open"></i>Discos</button>
  </div>

  <script>
    const API_KEY = 'patzIKAjwQnDtoIme.1aca2da0458d3f76cb528a285652d695a5acd97dee0ed3af3ddcbbeff2daaac6';
    const BASE_ID = 'appVh4GZeAWJ06uey';
    const T_NEWS = "Noticias";
    const T_DISCO = "Discografia";
    const T_MEMBERS = "tblaFURTBeUVGx6IW"; 
    const IMGBB_KEY = "81f7ca81cf22d739de576bd1dac7dcc2"; 

    let allMembers = [];
    let allDiscos = [];
    let activeSlot = null;
    let tracksBuffer = [];

    function $(id){ return document.getElementById(id); }
    function val(id){ const el = $(id); return el ? el.value : ""; }
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

    function showLoading(show, txt){
      const el = $('loading-overlay');
      el.style.display = show ? 'flex' : 'none';
      if (txt) $('loading-text').innerText = txt;
      $('loading-log').innerHTML = '';
    }
    function log(msg){ $('loading-log').innerHTML += `<div>${msg}</div>`; }

    function nav(id, el){
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
      $('tab-'+id).classList.add('active');
      el.classList.add('active');
    }

    async function api(table, method, body, id = null) {
      const tName = table.startsWith('tbl') ? table : encodeURIComponent(table);
      const url = `https://api.airtable.com/v0/${BASE_ID}/${tName}${id ? '/' + id : ''}`;
      const opts = { method, headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' } };
      if (body) { body.typecast = true; opts.body = JSON.stringify(body); }
      return fetch(url, opts);
    }

    async function uploadImage(input, targetId, statusId){
      const file = input.files[0];
      if(!file) return;
      const statusEl = $(statusId);
      const targetEl = $(targetId);
      statusEl.innerText = "‚è≥ Enviando imagem...";
      try{
        const base64 = await new Promise((resolve,reject)=>{
          const reader = new FileReader();
          reader.onload = ()=>resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        const form = new URLSearchParams();
        form.append("key", IMGBB_KEY);
        form.append("image", base64.split(",")[1]);
        const res = await fetch("https://api.imgbb.com/1/upload", { method:"POST", body: form });
        const data = await res.json();
        if(!data?.success) throw new Error(data?.error?.message || "Erro no upload");
        targetEl.value = data.data.url;
        statusEl.innerText = "‚úÖ Imagem carregada!";
        if(targetId === 'e-photo') $('e-preview').src = data.data.url;
      }catch(e){ console.error(e); statusEl.innerText = "‚ùå Erro: " + e.message; }
    }

    // === LOADERS ===
    async function loadMembers(){
      try {
        const r = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${T_MEMBERS}?sort%5B0%5D%5Bfield%5D=Time`, { headers: { Authorization: `Bearer ${API_KEY}` } });
        const d = await r.json();
        if(d.error) throw d.error;
        allMembers = (d.records||[]).map(x=>({ id: x.id, name: x.fields?.Nome || '', photo: x.fields?.Foto?.[0]?.url || '', team: x.fields?.Time || '', gen: x.fields?.Geracao || '', status: x.fields?.Status || 'Ativa', part: x.fields?.Participacoes || '' }));
        
        // Inicializa listas
        renderMemberSelectionList("");
        renderManageSelect("");
      } catch(e) { console.error(e); alert("Erro ao carregar membros."); }
    }

    // --- FUN√á√ïES DE RENDERIZA√á√ÉO DE LISTA ---
    function renderMemberSelectionList(filterText = "") {
        const gl = $('selection-list');
        if (!gl) return;
        const q = filterText.trim().toLowerCase();
        gl.innerHTML = '';
        const filtered = allMembers.filter(m => (m.status !== 'Graduada' && m.status !== 'Demitida') && (!q || m.name.toLowerCase().includes(q)));
        if(filtered.length === 0) { gl.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;font-weight:900;">Nenhum membro</div>'; return; }
        filtered.forEach(m => {
            const div = document.createElement('div'); div.className = 'select-item';
            div.innerHTML = `<img src="${m.photo || 'https://placehold.co/100'}"><div>${m.name}</div>`;
            div.onclick = () => selectMember(m);
            gl.appendChild(div);
        });
    }

    function renderManageSelect(filterText = "") {
        const sl = $('manage-selector');
        if (!sl) return;
        const q = filterText.trim().toLowerCase();
        sl.innerHTML = '<option value="">Selecione...</option>';
        allMembers
            .filter(m => !q || m.name.toLowerCase().includes(q))
            .forEach(m => {
                const o = document.createElement('option'); o.value = m.id; o.textContent = m.name;
                sl.appendChild(o);
            });
    }

    async function loadDiscos() {
      try {
        const r = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(T_DISCO)}?pageSize=100&sort%5B0%5D%5Bfield%5D=Data&sort%5B0%5D%5Bdirection%5D=desc`, { headers: { Authorization: `Bearer ${API_KEY}` }});
        const d = await r.json();
        allDiscos = (d.records || []).map(rec => ({ id: rec.id, fields: rec.fields || {} }));
        const sel = $('disco-selector');
        if (sel) { sel.innerHTML = '<option value="">Selecione...</option>'; allDiscos.forEach(rec => { const title = rec.fields["Titulo"] || "(Sem t√≠tulo)"; const opt = document.createElement('option'); opt.value = rec.id; opt.textContent = title; sel.appendChild(opt); }); }
      } catch (err) { console.error(err); }
    }

    async function uploadGalleryFiles(input) {
      const files = Array.from(input.files || []);
      const statusEl = $('e-gallery-status');
      const box = $('e-gallery');
      if (!files.length) return;
      if (statusEl) statusEl.innerText = `‚è≥ Enviando ${files.length}...`;
      try {
        const urls = [];
        for (const file of files) {
          const base64 = await new Promise((resolve, reject) => { const r = new FileReader(); r.onload = () => resolve(r.result); r.onerror = reject; r.readAsDataURL(file); });
          const form = new URLSearchParams(); form.append("key", IMGBB_KEY); form.append("image", String(base64).split(",")[1]);
          const res = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: form });
          const data = await res.json();
          if (!data?.success) throw new Error("Erro upload");
          urls.push(data.data.url);
          await sleep(150);
        }
        const current = (box.value || "").trim();
        box.value = current ? (current + "\n" + urls.join("\n")) : urls.join("\n");
        if (statusEl) statusEl.innerText = "‚úÖ Galeria atualizada!";
      } catch (e) { if (statusEl) statusEl.innerText = "Erro"; }
    }

    // === PARSER ===
    function parseHTMLToTracks(htmlString) {
        if (!htmlString) return [];
        const buffer = [];
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');
        const listItems = doc.querySelectorAll('.tracklist li');
        let formationGroups = doc.querySelectorAll('.formation-group');
        if(formationGroups.length === 0) formationGroups = doc.querySelectorAll('.rows-wrap');

        listItems.forEach((li, index) => {
            const link = li.querySelector('a');
            const name = link ? link.innerText : (li.innerText || 'M√∫sica').split(' ')[0];
            const label = li.querySelector('.label');
            let kind = 'B-side';
            let unitName = "";
            if (label) {
                const classKind = label.classList[1] || '';
                if(classKind.includes('a-side')) kind = 'A-side';
                else if(classKind.includes('under')) kind = 'Undergirls';
                else if(classKind.includes('unit')) kind = 'Unit';
                else if(classKind.includes('solo')) kind = 'Solo';
                if(kind === 'Unit' && label.innerText !== 'Unit') unitName = label.innerText;
            }
            let members = [];
            let group = formationGroups[index];
            if (group) {
                const slots = group.querySelectorAll('.slot');
                if (slots.length > 0) {
                    slots.forEach(s => {
                        const mId = s.dataset.id; const mName = s.dataset.name;
                        const isCenter = s.classList.contains('is-center') || s.dataset.isCenter === 'true';
                        if(mId) members.push({ id: mId, name: mName, isCenter });
                    });
                } else {
                    const cards = group.querySelectorAll('.member-card-static');
                    cards.forEach(c => {
                        const h3 = c.querySelector('h3'); const mName = h3 ? h3.innerText : '';
                        const isCenter = c.classList.contains('is-center');
                        const found = allMembers.find(m => m.name === mName);
                        if(found) members.push({ id: found.id, name: found.name, isCenter });
                    });
                }
            }
            buffer.push({ name, kind, unitName, members, center: '', html: null }); 
        });
        return buffer;
    }

    // === FORMS ===
    async function fillEditForm() {
      const id = val('manage-selector');
      const f = $('edit-form');
      if (!id) { if (f) f.style.display = 'none'; return; }
      const res = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${T_MEMBERS}/${id}`, { headers: { 'Authorization': `Bearer ${API_KEY}` } });
      const data = await res.json();
      const fields = data.fields || {};
      $('e-name').value = fields.Nome || '';
      $('e-status-select').value = fields.Status || 'Ativa';
      $('e-team').value = fields.Time || 'Team C';
      $('e-gen').value = (fields.Geracao || '').replace('¬™ Gera√ß√£o','').trim();
      const photoUrl = (fields.Foto && fields.Foto[0] && fields.Foto[0].url) ? fields.Foto[0].url : '';
      $('e-photo').value = photoUrl;
      if ($('e-preview')) $('e-preview').src = photoUrl || 'https://placehold.co/100';
      if ($('e-bio')) $('e-bio').value = fields.Perfil || '';
      const galUrls = Array.isArray(fields.Galeria) ? fields.Galeria.map(x => x.url).filter(Boolean) : [];
      if ($('e-gallery')) $('e-gallery').value = galUrls.join('\n');
      $('e-part').value = fields.Participacoes || '';
      if ($('e-upload-status')) $('e-upload-status').innerText = "";
      if ($('e-gallery-status')) $('e-gallery-status').innerText = "";
      if (f) f.style.display = 'block';
    }

    function fillDiscoEditForm() {
      const id = $('disco-selector')?.value;
      const formBox = $('disco-edit-form');
      if (!id) { if (formBox) formBox.style.display = 'none'; return; }
      const rec = allDiscos.find(r => r.id === id);
      if (!rec) return;
      const f = rec.fields;
      $('ed-title').value = f["Titulo"] || "";
      $('ed-type').value = f["Tipo"] || "Single";
      $('ed-date').value = (f["Data"] || "").slice(0,10);
      $('ed-center').value = f["Center"] || "";
      $('ed-cover').value = f["Capa"] || "";
      $('ed-tracklist').value = f["Tracklist"] || "";
      const tipos = f["Tipo da faixa"];
      $('ed-tipos').value = Array.isArray(tipos) ? tipos.join(", ") : (tipos || "");
      
      const oldHTML = f["Tracklist"] || "";
      tracksBuffer = parseHTMLToTracks(oldHTML);
      updateTracks(true); // Atualiza a lista visual na tela de edi√ß√£o

      if (formBox) formBox.style.display = 'block';
    }

    // === ACTIONS ===
    async function saveMember(e) {
      e.preventDefault();
      const genStr = val('m-gen') + "¬™ Gera√ß√£o";
      const fields = { "Nome": val('m-name'), "Time": val('m-team'), "Geracao": genStr, "Status": val('m-status-select'), "Foto": val('m-photo') ? [{ url: val('m-photo') }] : [], "Perfil": val('m-bio') || "" };
      const ok = await api(T_MEMBERS, 'POST', { fields });
      if (ok.ok) { alert('Membro cadastrado!'); location.reload(); } else { alert("Erro."); }
    }

    async function updateMember(e) {
      e.preventDefault();
      const id = val('manage-selector'); if (!id) return;
      const galleryLines = (val('e-gallery') || '').split('\n').map(s => s.trim()).filter(Boolean);
      const genStr = val('e-gen') + "¬™ Gera√ß√£o";
      const fields = { "Nome": val('e-name'), "Time": val('e-team'), "Geracao": genStr, "Status": val('e-status-select'), "Foto": val('e-photo') ? [{ "url": val('e-photo') }] : [], "Perfil": val('e-bio') || '', "Galeria": galleryLines.map(url => ({ url })), "Participacoes": val('e-part') || '' };
      const ok = await api(T_MEMBERS, 'PATCH', { fields }, id);
      if (ok.ok) { alert('Atualizado!'); location.reload(); } else { alert('Erro.'); }
    }

    async function saveNews(e){
      e.preventDefault();
      const r = await api(T_NEWS, 'POST', { fields:{ "Titulo": val('n-title'), "Categoria": val('n-cat'), "Data": val('n-date'), "Texto": val('n-text') }});
      if(r.ok){ alert('Not√≠cia Salva!'); location.reload(); } else { alert('Erro.'); }
    }

    // === SAVE / UPDATE DISCO ===
    function buildHTML() {
        let html = `<div class="modal-nav"><button class="modal-nav-btn active" data-section="tracklist">Tracklist</button><button class="modal-nav-btn" data-section="formacao">Forma√ß√£o</button></div><div class="details-content"><div class="modal-section active" data-section="tracklist"><ol class="tracklist">`;
        let forms = `<div class="modal-section" data-section="formacao">`;

        tracksBuffer.forEach((t, index) => {
          const kindLabel = t.kind || 'B-side';
          const unitTxt = t.unitName ? ` ‚Ä¢ ${t.unitName}` : '';
          html += `<li><a>${t.name}</a> <span class="label ${t.kind.toLowerCase()}">${kindLabel}${unitTxt}</span></li>`;
          
          forms += `<div class="formation-group"><div class="formation-title">${t.kind === 'Unit' ? '<i class="fas fa-users"></i>' : ''} ${t.name}</div><div class="member-grid">`;
          t.members.forEach(mem => {
              const fullMem = allMembers.find(am => am.id === mem.id);
              if(!fullMem) return;
              const centerClass = mem.isCenter ? 'is-center' : '';
              const genTxt = (fullMem.gen || '').replace('¬™ Gera√ß√£o', '¬™ Gen'); 
              forms += `<a class="member-card-static ${centerClass}"><div class="member-photo"><img src="${fullMem.photo}" loading="lazy"></div><div class="member-info"><h3>${fullMem.name}</h3><p>${genTxt}</p></div></a>`;
          });
          forms += `</div></div>`; 
          if(index < tracksBuffer.length - 1) forms += `<hr class="formation-separator"/>`;
        });
        forms += `</div></div>`; 
        return html + forms;
    }

    async function saveDisco(e) {
      e.preventDefault();
      if (!tracksBuffer.length) { alert('Adicione m√∫sicas!'); return; }
      showLoading(true, "Salvando...");
      try {
        const html = buildHTML();
        const tipos = [...new Set(tracksBuffer.map(t => {
             const k = String(t.kind).toLowerCase();
             if (k.includes('a-side')) return 'A-side';
             if (k.includes('b-side')) return 'B-side';
             if (k.includes('under')) return 'Undergirls';
             if (k.includes('unit')) return 'Unit';
             if (k.includes('solo')) return 'Solo';
             return 'B-side';
        }))];
        const firstTrack = tracksBuffer[0];
        const centerStr = firstTrack ? firstTrack.members.filter(m=>m.isCenter).map(m=>m.name).join(' & ') : '';

        const fields = { "Titulo": val('d-title'), "Tipo": val('d-type'), "Tipo da faixa": tipos, "Center": centerStr || val('d-center'), "Data": val('d-date'), "Capa": val('d-cover'), "Tracklist": html };
        const dRes = await api(T_DISCO, 'POST', { fields });
        if (!dRes.ok) throw await dRes.json();
        
        await updateMembersHistory(val('d-title'), tracksBuffer);
        setTimeout(() => { showLoading(false); alert("Sucesso!"); location.reload(); }, 700);
      } catch (err) { showLoading(false); alert('Erro: ' + err); }
    }

    async function updateDisco(e) {
      e.preventDefault();
      const id = $('disco-selector')?.value;
      if (!id) return;
      showLoading(true, "Atualizando (Regerando HTML)...");
      
      const html = buildHTML(); 
      const firstTrack = tracksBuffer[0];
      const centerStr = firstTrack ? firstTrack.members.filter(m=>m.isCenter).map(m=>m.name).join(' & ') : '';

      const fields = { "Tipo": $('ed-type').value, "Data": $('ed-date').value, "Center": centerStr, "Capa": $('ed-cover').value, "Tracklist": html };
      
      const res = await api(T_DISCO, 'PATCH', { fields }, id);
      if (res.ok) { alert("Atualizado!"); location.reload(); } else { alert("Erro."); showLoading(false); }
    }

    async function updateMembersHistory(singleTitle, tracks) {
        const memberUpdates = {};
        tracks.forEach(track => {
          if(!track.members) return;
          const baseLabel = track.kind || 'b-side';
          track.members.forEach(mem => {
            if (!mem?.id) return;
            if (!memberUpdates[mem.id]) memberUpdates[mem.id] = [];
            const labels = [baseLabel];
            if (track.kind === 'unit') labels.push('unit');
            if (mem.isCenter) labels.push('center');
            memberUpdates[mem.id].push({ title: track.name, labels, unitName: track.unitName || '' });
          });
        });
        
        for (const [memId, newTracks] of Object.entries(memberUpdates)) {
             const getRes = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${T_MEMBERS}/${memId}`, { headers: { 'Authorization': `Bearer ${API_KEY}` } });
             const getData = await getRes.json();
             let currentHist = [];
             try { currentHist = JSON.parse(getData.fields.Participacoes || '[]'); } catch (e) {}
             currentHist.push({ single: singleTitle, tracks: newTracks });
             await api(T_MEMBERS, 'PATCH', { fields: { "Participacoes": JSON.stringify(currentHist) } }, memId);
             await sleep(200);
        }
    }

    async function deleteDisco() {
      const id = $('disco-selector')?.value;
      const title = $('ed-title')?.value;
      if (!id || !title) return;
      if (!confirm(`Tem certeza?`)) return;
      showLoading(true, "Deletando...");
      try {
        await api(T_DISCO, 'DELETE', null, id);
        alert(`Deletado!`); location.reload();
      } catch (e) { showLoading(false); alert("Erro"); }
    }

    // === BUILDER & UI ===
    function openBuilder(){ $('builder-modal').style.display='flex'; $('builder-modal').classList.add('active'); $('step-1').style.display='block'; $('step-2').style.display='none'; if(!$('row-inputs').children.length) renderRowInputs(); toggleKindRules(); syncRowsUI(); }
    function closeBuilder(goToMenu=true){ $('builder-modal').classList.remove('active'); $('builder-modal').style.display='none'; if(goToMenu){ $('step-1').style.display='block'; $('step-2').style.display='none'; } }
    function backToFormationMenu(){ $('step-2').style.display='none'; $('step-1').style.display='block'; }
    function syncRowsUI(){ const total = parseInt(val('b-total'))||0; $('rows-total').innerText = total; updateRowsSum(); }
    function renderRowInputs(){ 
        const wrap = $('row-inputs'); const count = parseInt(val('b-rowcount'))||3; 
        const old = [...wrap.querySelectorAll('.row-count-input')].map(i=>parseInt(i.value)||0);
        wrap.innerHTML='';
        for(let i=0;i<count;i++){ wrap.innerHTML += `<div class="rowline"><div class="row-tag">${i===0?'Frente':(i===count-1?'Fundo':`Meio ${i}`)}</div><input type="number" min="0" class="row-count-input" value="${old[i]||0}" oninput="updateRowsSum()"></div>`; }
        updateRowsSum();
    }
    function updateRowsSum(){ const total = parseInt(val('b-total'))||0; const sum = [...document.querySelectorAll('.row-count-input')].reduce((a,b)=>a+(parseInt(b.value)||0),0); $('rows-sum').innerText = sum; $('rows-sum').style.color = (sum===total) ? '#00b894' : '#e91e63'; }
    function toggleKindRules(){ 
        const kind = val('b-kind'); $('unit-fields').style.display = (kind === 'Unit') ? 'block' : 'none'; 
        if(kind === 'Solo'){ $('b-total').value = 1; $('b-centers').value = 1; syncRowsUI(); if(!$('row-inputs').children.length) renderRowInputs(); const inputs=[...document.querySelectorAll('.row-count-input')]; inputs.forEach(i=>i.value=0); if(inputs[0]) inputs[0].value=1; updateRowsSum(); }
    }
    function startStage(){
        const total = parseInt(val('b-total'))||0;
        const inputs = [...document.querySelectorAll('.row-count-input')].map(i=>parseInt(i.value)||0);
        if(inputs.reduce((a,b)=>a+b,0) !== total){ alert(`Soma incorreta.`); return; }
        const centerCount = parseInt(val('b-centers')) || 0;
        const frontRowCount = inputs[0] || 0;
        let centerIndices = [];
        if (centerCount > 0 && frontRowCount > 0) {
            const start = Math.floor((frontRowCount - centerCount) / 2);
            for(let k=0; k<centerCount; k++) centerIndices.push(start + k);
        }
        const slotsWrap = $('slots'); slotsWrap.innerHTML='';
        let idx=1;
        const rowsWrap = document.createElement('div'); rowsWrap.className='rows-wrap';
        for(let r=inputs.length-1; r>=0; r--){
            const rowDiv = document.createElement('div'); rowDiv.className='slots-row';
            const isFrontRow = (r === 0);
            for(let j=0; j<inputs[r]; j++){
                const d=document.createElement('div'); d.className='slot'; d.dataset.index=idx;
                if (isFrontRow && centerIndices.includes(j)) d.classList.add('is-center');
                d.innerHTML = `<div class="slot-badge">${idx++}</div><div class="slot-circle"><i class="fas fa-plus" style="color:#ddd"></i></div><div class="slot-name">-</div>`;
                d.onclick=()=>openMemberModal(d);
                rowDiv.appendChild(d);
            }
            rowsWrap.appendChild(rowDiv);
        }
        slotsWrap.appendChild(rowsWrap);
        $('step-1').style.display='none'; $('step-2').style.display='block';
    }
    
    function openMemberModal(slotEl){ 
        activeSlot = slotEl; 
        $('member-select-modal').style.display='flex'; 
        
        // Reset Search
        const search = $('member-search');
        if(search) { search.value = ""; search.focus(); renderMemberSelectionList(""); }
    }

    function closeMemberModal(){ $('member-select-modal').style.display='none'; activeSlot=null; }
    
    function selectMember(m){
        if(!activeSlot) return;
        activeSlot.querySelector('.slot-circle').innerHTML = `<img src="${m.photo || 'https://placehold.co/100'}">`;
        activeSlot.querySelector('.slot-name').innerText = m.name;
        activeSlot.dataset.id=m.id; activeSlot.dataset.name=m.name; 
        closeMemberModal();
    }
    function clearSlot(){ if(activeSlot){ activeSlot.querySelector('.slot-circle').innerHTML = '<i class="fas fa-plus" style="color:#ddd"></i>'; activeSlot.querySelector('.slot-name').innerText='-'; delete activeSlot.dataset.id; } closeMemberModal(); }
    
    function finishTrack(){
        const name = val('b-song').trim(); if(!name){ alert('Nome?'); return; }
        const kind = val('b-kind');
        const unitName = val('b-unit-name');
        const slots = [...document.querySelectorAll('.slot')].filter(s=>s.dataset.id);
        if(!slots.length){ alert('Selecione membros.'); return; }
        const centerCount = parseInt(val('b-centers'))||1;
        const sortedSlots = slots.sort((a,b)=>parseInt(a.dataset.index)-parseInt(b.dataset.index));
        const centers = sortedSlots.slice(0, centerCount);
        const members = sortedSlots.map(s => ({ id: s.dataset.id, name: s.dataset.name, isCenter: s.classList.contains('is-center') }));
        
        tracksBuffer.push({ name, kind, unitName, members, html: null }); 
        updateTracks(true); closeBuilder(true);
    }
    
    function updateTracks(isEdit = false){
        const listId = isEdit ? 'ed-tracks-list' : 'tracks-list';
        const c = $(listId); 
        if(!c) return;
        c.innerHTML = tracksBuffer.length ? '' : '<div style="text-align:center;color:#999;font-size:0.85rem;">Vazio</div>';
        tracksBuffer.forEach((t,i)=>{
            c.innerHTML += `<div class="track-item"><div><b>${t.name}</b> <span class="badge">${t.kind}</span></div><button onclick="tracksBuffer.splice(${i},1);updateTracks(${isEdit})" style="color:red;border:none;background:none;font-weight:900;">X</button></div>`;
        });
    }
    
    async function captureFormation(){
        const area = $('slots'); if(!area) return;
        const canvas = await html2canvas(area, { backgroundColor:"#ffffff", scale:2 });
        const link = document.createElement('a'); link.download = `formacao-${Date.now()}.png`; link.href = canvas.toDataURL('image/png'); link.click();
    }

    loadMembers();
    loadDiscos();
  </script>
</body>
</html>
